'use strict';function e(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,t=new Array(r);n<r;n++)t[n]=e[n];return t}function r(r,n){var it="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(it)return(it=it.call(r)).next.bind(it);if(Array.isArray(r)||(it=function(r,n){if(r){if("string"==typeof r)return e(r,n);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?e(r,n):void 0}}(r))||n&&r&&"number"==typeof r.length){it&&(r=it);var t=0;return function(){return t>=r.length?{done:1}:{done:0,value:r[t++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function n(e,r,n,t){(E(e)||z(e))&&('family'in e||'graphite'in e)||M(r+": expect "+n+" to be a unit (store, event or effect)"+t)}function t(e,r,t){if(Array.isArray(e))for(var a=0;a<e.length;a++)n(e[a],r,a+" item of "+t,'');else n(e,r,t,' or array of units')}function a(e,r){var n=ue(e).meta;ye={parent:ye,value:e,template:n.template||be(),sidRoot:n.sidRoot||ye&&ye.sidRoot};try{return r()}finally{ye=ve(ye)}}function o(e){for(var r=void 0===e?{}:e,n=r.node,t=void 0===n?[]:n,a=r.parent,o=r.child,i=void 0===o?r.to||r.target:o,u=r.scope,f=void 0===u?{}:u,c=r.meta,s=void 0===c?{}:c,l=r.family,p=void 0===l?{type:'regular'}:l,d=r.regional,m=we(void 0===a?r.from||r.source:a),v=we(p.links),h=we(p.owners),g=[],y={},b=0;b<t.length;b++){var k=t[b];k&&(g.push(k),xe(k,y))}for(var w={id:B(),seq:g,next:we(i),meta:s,scope:f,family:{type:p.type||"crosslink",links:v,owners:h},reg:y},x=0;x<v.length;x++)fe(v[x]).push(w);for(var S=0;S<h.length;S++)ce(h[S]).push(w);for(var A=0;A<m.length;A++)m[A].next.push(w);return d&&ye&&ge(de(ye),[w]),w}function i(e,r,n){var t=Me,a=null,o=je;if(e.target&&(r=e.params,n=e.defer,t='page'in e?e.page:t,e.stack&&(a=e.stack),o=he(e)||o,e=e.target),o&&je&&o!==je&&(je=null),Array.isArray(e))for(var i=0;i<e.length;i++)Pe('pure',t,ue(e[i]),a,r[i],o);else Pe('pure',t,ue(e),a,r,o);if(!n||De){var u,f,c,s,l,p,d={isRoot:De,currentPage:Me,forkPage:je,isWatch:Ie};De=0;e:for(;s=Ce();){var m=s.idx,v=s.stack,h=s.type;c=v.node,Me=l=v.page,je=he(v),p=(l||c).reg;var g={fail:0,scope:c.scope};u=f=0;for(var y=m;y<c.seq.length&&!u;y++){var b=c.seq[y],k=b.data;switch(b.type){case"barrier":var w=k.barrierID;l&&(w=l.fullID+"_"+w);var x=k.priority;if(y!==m||h!==x){_e.has(w)||(_e.add(w),Fe(y,v,x,w));continue e}_e.delete(w);break;case'mov':var S=void 0;switch(k.from){case O:S=de(v);break;case"a":case'b':S=v[k.from];break;case"value":S=k.store;break;case N:p[k.store.id]||(v.page=l=Te(l,k.store.id),p=l?l.reg:c.reg),S=te(p[k.store.id])}switch(k.to){case O:v.value=S;break;case"a":case'b':v[k.to]=S;break;case N:We(l,c,k.target.id).current=S}break;case'check':switch(k.type){case'defined':f=void 0===de(v);break;case'changed':f=de(v)===te(We(l,c,k.store.id))}break;case"filter":f=!He(g,k,v);break;case'run':if(y!==m||"effect"!==h){Fe(y,v,"effect");continue e}case'compute':Ie='watch'===c.meta.op,v.value=He(g,k,v),Ie=d.isWatch}u=g.fail||f}if(!u)for(var A=0;A<c.next.length;A++)Pe('child',l,c.next[A],v,de(v),he(v))}De=d.isRoot,Me=d.currentPage,je=he(d)}}function u(e,r){void 0===r&&(r='combine');var n=r+'(',t='',a=0;for(var o in e){var i=e[o];if(null!=i&&(n+=t,n+=C(i)?i.compositeName.fullName:i.toString()),25===(a+=1))break;t=', '}return n+')'}function f(e,r){var n,t,a,o=e;return r?(a=r.compositeName,0===e.length?(n=a.path,t=a.fullName):(n=a.path.concat([e]),t=0===a.fullName.length?e:a.fullName+'/'+e)):(n=0===e.length?[]:[e],t=e),{shortName:o,fullName:t,path:n}}function c(e,r){for(var n in e)r(e[n],n)}function s(e,r){e.forEach(r)}function l(e,r,n,t){var a=Me,o=null;if(r)for(o=Me;o&&o.template!==r;)o=ve(o);ze(o);var i=e.create(n,t);return ze(a),i}function p(e,r){var n=function e(r){for(var n=arguments.length,a=new Array(n>1?n-1:0),o=1;o<n;o++)a[o-1]=arguments[o];return Me?l(e,t,r,a):e.create(r,a)};n.graphite=o({meta:ar("event",n,r,e),regional:1}),n.create=function(e){return i(je?je.find(n):n,e),e},n.watch=G(rr,n),n.map=function(e){var r,t;E(e)&&(r=e,t=e.name,e=e.fn);var a=p(Be(n,t),r);return ir(n,a,j,e),a},n.filter=function(e){return ur(n,"filter",e.fn?e:e.fn,[Y({fn:ie})])},n.filterMap=function(e){return ur(n,'filterMap',e,[X({fn:ie}),Q.defined()])},n.prepend=function(e){var r=p('* → '+n.shortName,{parent:ve(n)}),t=be();return t&&ue(r).seq.push(t.upward),ir(r,n,'prepend',e),tr(n,r),r};var t=be();return n}function d(e,n){function a(e,r){p.off(e),me(p).set(e,Ye(fr(e,p,'on',1,r,v)))}var u=ne(e),f=ne(e),c=or('updates'),s=be();u.after=[{type:'copy',to:f}],s&&s.plain.push(u,f);var l=u.id,p={subscribers:new Map,updates:c,defaultState:e,stateRef:u,getState:function(){var e,r=u;if(Me){for(var n=Me;n&&!n.reg[l];)n=ve(n);n&&(e=n)}return!e&&je&&je.reg[l]&&(e=je),e&&(r=e.reg[l]),te(r)},setState:function(e){var r;je&&(r=je.nodeMap[ue(p).id]),r||(r=p),i({target:r,params:e,defer:1})},reset:function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];for(var t=0,a=r;t<a.length;t++){var o=a[t];p.on(o,(function(){return p.defaultState}))}return p},on:function(e,n){if(t(e,'.on','first argument'),Array.isArray(e))for(var o,i=r(e);!(o=i()).done;)a(o.value,n);else a(e,n);return p},off:function(e){var r=me(p).get(e);return r&&(r(),me(p).delete(e)),p},map:function(e,r){var n,t,a;E(e)&&(n=e,t=e.name,r=e.firstState,e=e.fn);var o=p.getState(),i=be();i?a=null:void 0!==o&&(a=e(o,r));var f=d(a,{name:Be(p,t),config:n,strict:0}),c=fr(p,f,j,0,e);return se(f).before=[{type:j,fn:e,from:u}],i&&($e(i.plain,u)||$e(c.seq,i.loader)||c.seq.unshift(i.loader)),f},watch:function(e,r){if(!r||!C(e)){var n=rr(p,e),t=be();return t?t.watch.push({of:u,fn:e}):e(p.getState()),n}return z(r)||M('second argument should be a function'),e.watch((function(e){return r(p.getState(),e)}))}},m=ar(N,p,n),v=p.defaultConfig.updateFilter;return p.graphite=o({scope:{state:u},node:[Q.defined(),Q.changed({store:f}),v&&L({store:f,to:"a"}),v&&Y({fn:function(e,r,n){return v(e,n.a)}}),ee({store:u}),ee({store:f})],child:c,meta:m,regional:1}),Oe&&void 0===e&&M("current state can't be undefined, use null instead"),ge(p,[c]),p}function m(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];var t,a,o;Ge(r[0],(function(e,n){o=e,r=n}));var i,u,f=r[r.length-1];if(z(f)?(a=r.slice(0,-1),t=f):a=r,1===a.length){var c=a[0];F(c)||(i=c,u=1)}return u||(i=a,t&&(t=cr(t))),E(i)||M('shape should be an object'),sr(Array.isArray(i),i,o,t)}function v(){var e={};return e.req=new Promise((function(r,n){e.rs=r,e.rj=n})),e.req.catch((function(){})),e}function h(e,r){var n=p(e,r),t=n.defaultConfig.handler||function(){return M("no handler used in "+n.getType())},a=ue(n);a.meta.onCopy=['runner'],a.meta.unit=n.kind="effect",n.use=function(e){return z(e)||M('.use argument should be a function'),t=e,n};var u=n.finally=or('finally'),f=n.done=u.filterMap({named:'done',fn:function(e){if('done'===e.status)return{params:e.params,result:e.result}}}),c=n.fail=u.filterMap({named:'fail',fn:function(e){if('fail'===e.status)return{params:e.params,error:e.error}}}),s=n.doneData=f.map({named:'doneData',fn:function(e){return e.result}}),l=n.failData=c.map({named:'failData',fn:function(e){return e.error}}),m=o({scope:{getHandler:n.use.getCurrent=function(){return t},finally:u},node:[Z({fn:function(e,r,n){var t,a=e.params,o=e.req,i=r.finally,u=r.getHandler,f=lr({params:a,req:o,ok:1,anyway:i,stack:n}),c=lr({params:a,req:o,ok:0,anyway:i,stack:n});try{t=u()(a)}catch(s){return void c(s)}E(t)&&z(t.then)?t.then(f,c):f(t)}})],meta:{op:'fx',fx:'runner',onCopy:['finally']}});a.scope.runner=m,a.seq.push(X({fn:function(e,r,n){return ve(n)?{params:e,req:{rs:function(){},rj:function(){}}}:e}}),Z({fn:function(e,r,n){return i({target:r.runner,params:e,defer:1,forkPage:he(n)}),e.params}})),n.create=function(e){var r=v(),t={params:e,req:r};if(je){if(!Ie){var a=je;r.req.finally((function(){Ee(a)})).catch((function(){}))}i(je.find(n),t)}else i(n,t);return r.req};var h=n.inFlight=d(0,{named:'inFlight'}).on(n,(function(e){return e+1})).on(u,(function(e){return e-1})),g=n.pending=h.map({fn:function(e){return e>0},named:'pending'});return ge(n,[u,f,c,s,l,g,h,m]),n}function g(e,r){var n=p(r||u(e,'merge'));return t(e,'merge','first argument'),er({from:e,to:n,meta:{op:'merge'}}),n}function y(e){var r=0;return s(mr,(function(n){n in e&&(null==e[n]&&M("sample: "+n+" should be defined"),r=1)})),r}function b(){for(var e,r,n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];var u,f,c=Ve(a),s=c[0],l=s[0],v=s[1],h=s[2],b=c[1];void 0===v&&E(l)&&y(l)&&(v=l.clock,h=l.fn,f=l.greedy,e=l.target,r=l.name,u=l.sid,l=l.source);var k=1;void 0===l&&(t(v,'sample','clock'),Array.isArray(v)&&(v=g(v)),l=v,k=0),k&&!C(l)&&(l=m(l)),void 0===v&&(v=l),t(v,'sample','clock'),r=b||r||l.shortName;var w=be(),x=!!e;if(!e)if(F(l)&&F(v)){var S=h?h(te(se(l)),te(se(v))):te(se(l));e=d(S,{name:r,sid:u})}else e=p(r),w&&ue(e).seq.push(w.loader);var A=x&&C(e)&&ue(e).meta.nativeTemplate;if(F(l)){var q=se(l);ge(l,[Ze(v,e,{scope:{fn:h,targetTemplate:A},node:[w&&w.loader,!f&&K({priority:"sampler"}),L({store:q,to:h?"a":O}),h&&X({fn:oe}),w&&x&&w.upward],meta:{op:"sample",sample:N}})]),w&&($e(w.plain,q)||$e(w.closure,q)||w.closure.push(q))}else{var j=ne(0),P=ne(),R=ne();w&&w.plain.push(j,P,R),o({parent:l,node:[ee({store:P}),L({from:"value",store:1,target:j})],family:{owners:[l,e,v],links:e},meta:{op:"sample",sample:'source'},regional:1}),ge(l,[Ze(v,e,{scope:{fn:h,targetTemplate:A},node:[w&&w.loader,ee({store:R}),L({store:j}),Y({fn:function(e){return e}}),!f&&K({priority:"sampler"}),L({store:P}),L({store:R,to:"a"}),h&&X({fn:ae}),w&&x&&w.upward],meta:{op:"sample",sample:'clock'}})])}return e}function k(e){var r=Object.values(e),n={};return s(r,(function(e){n[e.id]=[]})),s(r,(function(e){var r=e.id,t=e.before,a=e.after;t&&s(t,(function(e){n[e.from.id].push(r)})),a&&s(a,(function(e){n[r].push(e.to.id)}))})),n}function w(e,n){if(void 0===n&&(n=function(){}),e instanceof Map){for(var t,a={},o=r(e);!(t=o()).done;){var i=t.value,u=i[0],f=i[1];C(u)||M('Map key should be a unit'),n(u,f),a[u.sid]=f}return a}return e}function x(e,r){function n(e){u[e]=1;for(var r=t[e],a=0;a<r.length;a++){var f=r[a];u[f]||i[f]||n(f)}u[e]=0,i[e]=1,o.push(e)}var t={};for(var a in e)t[a]=[].concat(new Set(e[a]));var o=[],i={},u={};for(var f in t)i[f]||u[f]||n(f);return o.reverse(),r&&r.size>0&&function(){for(var e,n=[],a=[].concat(r);e=a.shift();)n.push(e),s(t[e],(function(e){$e(n,e)||$e(a,e)||a.push(e)}));s(n,(function(e){Je(o,e)}))}(),o}function S(e){var r=[];return function e(n){$e(r,n)||(r.push(n),A(n,e))}(ue(e)),r}function A(e,r){var n=e.meta.unit;'fork'!==n&&"forkInFlightCounter"!==n&&(s(e.next,r),s(fe(e),r),s(ce(e),r))}Object.defineProperty(exports,'__esModule',{value:1});for(var q='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',N='store',j='map',O='stack',C=function(e){return(z(e)||E(e))&&'kind'in e},P=function(e){return function(r){return C(r)&&r.kind===e}},F=P(N),R=P("event"),_=P("effect"),D=P("domain"),I={__proto__:null,unit:C,store:F,event:R,effect:_,domain:D},M=function(e){throw Error(e)},E=function(e){return'object'==typeof e&&null!==e},z=function(e){return'function'==typeof e},T=function(e){E(e)||z(e)||M('expect first argument be an object')},W=function(){var e=0;return function(){return(++e).toString(36)}},H=W(),U=W(),B=W(),G=function(e,r){return e.bind(null,r)},V=function(e,r,n){return e.bind(null,r,n)},$=function(e,r,n){return{id:U(),type:e,data:n,hasRef:r}},J=0,K=function(e){var r=e.priority;return $("barrier",0,{barrierID:++J,priority:void 0===r?"barrier":r})},L=function(e){var r=e.from,n=void 0===r?N:r,t=e.target,a=e.to;return $('mov',n===N,{from:n,store:e.store,to:void 0===a?t?N:O:a,target:t})},Q={defined:function(){return $('check',0,{type:'defined'})},changed:function(e){return $('check',1,{type:'changed',store:e.store})}},X=V($,'compute',0),Y=V($,"filter",0),Z=V($,'run',0),ee=function(e){return L({from:O,target:e.store})},re={__proto__:null,barrier:K,mov:L,check:Q,compute:X,filter:Y,run:Z,update:ee},ne=function(e){return{id:U(),current:e}},te=function(e){return e.current},ae=function(e,r,n){return(0,r.fn)(e,n.a)},oe=function(e,r,n){return(0,r.fn)(n.a,e)},ie=function(e,r){return(0,r.fn)(e)},ue=function(e){return e.graphite||e},fe=function(e){return e.family.owners},ce=function(e){return e.family.links},se=function(e){return e.stateRef},le=function(e){return e.config},pe=function(e){return e.ɔ},de=function(e){return e.value},me=function(e){return e.subscribers},ve=function(e){return e.parent},he=function(e){return e.forkPage},ge=function(e,r){for(var n=ue(e),t=0;t<r.length;t++){var a=ue(r[t]);"domain"!==n.family.type&&(a.family.type="crosslink"),fe(a).push(n),ce(n).push(a)}},ye=null,be=function(){return ye&&ye.template},ke=function(e){return e&&ye&&ye.sidRoot&&(e=ye.sidRoot+"ɔ"+e),e},we=function(e){void 0===e&&(e=[]);var r=[];if(Array.isArray(e))for(var n=0;n<e.length;n++)Array.isArray(e[n])?r.push.apply(r,e[n]):r.push(e[n]);else r.push(e);return r.map(ue)},xe=function(e,r){var n,t=e.type,a=e.data;e.hasRef&&(r[(n=a.store).id]=n),'mov'===t&&a.to===N&&(r[(n=a.target).id]=n)},Se=null,Ae=function e(r,n){if(!r)return n;if(!n)return r;var t,a=r.v.type===n.v.type;return(a&&r.v.id>n.v.id||!a&&"sampler"===r.v.type)&&(t=r,r=n,n=t),t=e(r.r,n),r.r=r.l,r.l=t,r},qe=[],Ne=0;Ne<5;)qe.push({first:null,last:null,size:0}),Ne+=1;var je,Oe,Ce=function(){for(var e=0;e<5;e++){var r=qe[e];if(r.size>0){if(2===e||3===e){r.size-=1;var n=Se.v;return Se=Ae(Se.l,Se.r),n}1===r.size&&(r.last=null);var t=r.first;return r.first=t.r,r.size-=1,t.v}}},Pe=function(e,r,n,t,a,o){return Fe(0,{a:null,b:null,node:n,parent:t,value:a,page:r,forkPage:o},e)},Fe=function(e,r,n,t){void 0===t&&(t=0);var a=Re(n),o=qe[a],i={v:{idx:e,stack:r,type:n,id:t},l:0,r:0};2===a||3===a?Se=Ae(Se,i):(0===o.size?o.first=i:o.last.r=i,o.last=i),o.size+=1},Re=function(e){switch(e){case'child':return 0;case'pure':return 1;case"barrier":return 2;case"sampler":return 3;case"effect":return 4;default:return-1}},_e=new Set,De=1,Ie=0,Me=null,Ee=function(e){je=e},ze=function(e){Me=e},Te=function(e,r){if(e){for(;e&&!e.reg[r];)e=ve(e);if(e)return e}return null},We=function(e,r,n){return(Te(e,n)||r).reg[n]},He=function(e,r,n){var t=r.fn;try{return t(de(n),e.scope,n)}catch(a){console.error(a),e.fail=1}},Ue=function(e,r){return''+e.shortName+r},Be=function(e,r){return null==r?Ue(e,' → *'):r},Ge=function(e,r){T(e),pe(e)&&r(le(e),pe(e))},Ve=function(e){var r;return Ge(e[0],(function(n,t){r=n,e=t})),[e,r]},$e=function(e,r){return e.includes(r)},Je=function(e,r){var n=e.indexOf(r);-1!==n&&e.splice(n,1)},Ke=function(e,r){Je(e.next,r),Je(fe(e),r),Je(ce(e),r)},Le=function e(r,n,t){var a;r.next.length=0,r.seq.length=0,r.scope=null;for(var o=ce(r);a=o.pop();)Ke(a,r),(n||t&&!r.meta.sample||"crosslink"===a.family.type)&&e(a,n,'on'!==a.meta.op&&t);for(o=fe(r);a=o.pop();)Ke(a,r),t&&"crosslink"===a.family.type&&e(a,n,'on'!==a.meta.op&&t)},Qe=function(e){return e.clear()},Xe=function(e,r){var n=(void 0===r?{}:r).deep,t=0;if(e.ownerSet&&e.ownerSet.delete(e),F(e))Qe(me(e));else if(D(e)){t=1;var a=e.history;Qe(a.events),Qe(a.effects),Qe(a.stores),Qe(a.domains)}Le(ue(e),!!n,t)},Ye=function(e){var r=V(Xe,e,void 0);return r.unsubscribe=r,r},Ze=function(e,r,n){return o({node:n.node,parent:e,child:r,scope:n.scope,meta:n.meta,family:{owners:[e,r],links:r},regional:1})},er=function(e){var r;Ge(e,(function(n,t){r=n,e=t}));var n=e.from,a=e.to,i=e.meta,u=void 0===i?{op:'forward'}:i;return t(n,'forward','"from"'),t(a,'forward','"to"'),r&&(u.config=r),Ye(o({parent:n,child:a,meta:u,family:{},regional:1}))},rr=function(e,r){if(z(r)||M('.watch argument should be a function'),je){var n=je.nodeMap[ue(e).id];n&&(e=n)}return Ye(o({scope:{fn:r},node:[Z({fn:ie})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))},nr=function e(r,n){return E(r)&&(e(le(r),n),null!=r.name&&(E(r.name)?e(r.name,n):z(r.name)?n.handler=r.name:n.name=r.name),r.loc&&(n.loc=r.loc),(r.sid||null===r.sid)&&(n.sid=r.sid),r.handler&&(n.handler=r.handler),r.updateFilter&&(n.updateFilter=r.updateFilter),ve(r)&&(n.parent=ve(r)),'strict'in r&&(n.strict=r.strict),r.named&&(n.named=r.named),e(pe(r),n)),n},tr=function(e,r,n){void 0===n&&(n="event"),ve(e)&&ve(e).hooks[n](r)},ar=function(e,r,n,t){var a=nr({name:t,config:n},{}),o="domain"===e,i=H(),u=a.parent,c=void 0===u?null:u,s=a.sid,l=void 0===s?null:s,p=a.strict,d=void 0===p?1:p,m=a.named,v=void 0===m?null:m,h=v||a.name||(o?'':i),g=f(h,c),y={unit:r.kind=e,name:r.shortName=h,sid:r.sid=ke(l),named:v,unitId:r.id=i};if(r.parent=c,r.compositeName=g,r.defaultConfig=a,r.thru=function(e){return e(r)},r.getType=function(){return g.fullName},!o){r.subscribe=function(e){return T(e),r.watch(z(e)?e:function(r){e.next&&e.next(r)})},r[q]=function(){return r};var b=be();b&&(y.nativeTemplate=b)}return Oe=d,y},or=function(e){return p({named:e})},ir=function(e,r,n,t){return Ze(e,r,{scope:{fn:t},node:[X({fn:ie})],meta:{op:n}})},ur=function(e,r,n,t){var a;E(n)&&(a=n,n=n.fn);var o=p(Ue(e,' →? *'),a);return Ze(e,o,{scope:{fn:n},node:t,meta:{op:r}}),o},fr=function(e,r,n,t,a,o){var i=se(r),u=[L({store:i,to:"a"}),X({fn:t?oe:ae}),Q.defined(),Q.changed({store:i}),o&&Y({fn:function(e,r,n){return o(e,n.a)}}),ee({store:i})],f=be();if(f&&(u.unshift(f.loader),u.push(f.upward),F(e))){var c=se(e);$e(f.plain,c)||($e(f.closure,c)||f.closure.push(c),i.before||(i.before=[]),i.before.push({type:'closure',of:c}))}return Ze(e,r,{scope:{fn:a},node:u,meta:{op:n}})},cr=function(e){return function(r){return e.apply(void 0,r)}},sr=function(e,r,n,t){var a=e?function(e){return e.slice()}:function(e){return Object.assign({},e)},o=e?[]:{},i=be(),f=a(o),s=ne(f),l=ne(1);s.type=e?'list':'shape',i&&i.plain.push(s,l);var p=d(f,{name:n||u(r)});ue(p).meta.isCombine=1;var m=[Q.defined(),L({store:s,to:"a"}),Y({fn:function(e,r,n){return e!==n.a[r.key]}}),L({store:l,to:'b'}),X({fn:function(e,r,n){var t=r.key;n.b&&(n.a=(0,r.clone)(n.a)),n.a[t]=e}}),L({from:"a",target:s}),L({from:"value",store:0,target:l}),K({priority:"barrier"}),L({from:"value",store:1,target:l}),L({store:s}),t&&X({fn:t}),Q.changed({store:se(p)})],v=s.before=[];return c(r,(function(e,r){if(F(e)){o[r]=e.defaultState,f[r]=e.getState();var n=Ze(e,p,{scope:{key:r,clone:a},node:m,meta:{op:'combine'}}),t=se(e);v.push({type:'field',field:r,from:t}),i&&($e(i.plain,t)||n.seq.unshift(i.loader))}else f[r]=o[r]=e})),p.defaultShape=r,s.after=[t?{type:j,to:se(p),fn:t}:{type:'copy',to:se(p)}],i||(p.defaultState=t?se(p).current=t(f):o),p},lr=function(e){var r=e.params,n=e.req,t=e.ok,a=e.anyway,o=e.stack;return function(e){return i({target:[a,pr],params:[t?{status:'done',params:r,result:e}:{status:'fail',params:r,error:e},{fn:t?n.rs:n.rj,value:e}],defer:1,page:o.page,forkPage:he(o)})}},pr=o({node:[Z({fn:function(e){(0,e.fn)(e.value)}})],meta:{op:'fx',fx:'sidechain'}}),dr=function(e,r,n){return e.create=function(r){return i(e,r),r},ue(e).seq.push(X({fn:function(e,r,n){return n.forkPage=null,e}})),e.watch((function(e){ge(n,[e]),r.add(e),e.ownerSet||(e.ownerSet=r),ve(e)||(e.parent=n)})),ge(n,[e]),function(n){return r.forEach(n),e.watch(n)}},mr=['source','clock','target'],vr=function(e,r,n,t){var a=e[r];a&&i({target:a,params:Array.isArray(a)?a.map((function(){return n})):n,defer:1,stack:t})};exports.allSettled=function(e,r){var n=r.scope,t=r.params;if(!C(e))return Promise.reject(Error('first argument should be unit'));var a=v();a.parentFork=je;var o=n.graphite.scope.forkInFlightCounter;o.scope.defers.push(a);var u=[n.find(e)],f=[];return _(e)?f.push({params:t,req:{rs:function(e){a.value={status:'done',value:e}},rj:function(e){a.value={status:'fail',value:e}}}}):f.push(t),u.push(o),f.push(null),i({target:u,params:f,forkPage:n}),a.req},exports.attach=function(e){var r,n;Ge(e,(function(r,t){n=r,e=t}));var t=e.source,a=e.effect,o=e.mapParams;o||(o=t?function(e,r){return r}:function(e){return e});var u,f=h(e,n),c=ue(f).scope.runner,s=function(e,r,n){var t,a=e.params,u=e.req,f=r.finally,c=r.effect,s=lr({params:a,req:u,ok:0,anyway:f,stack:n});try{t=o(a,n.a)}catch(l){return s(l)}i({target:c,params:{params:t,req:{rs:lr({params:a,req:u,ok:1,anyway:f,stack:n}),rj:s}},page:n.page,defer:1})};if(t){var l;F(t)?(l=t,ge(t,[f])):(l=m(t),ge(f,[l]));var p=L({from:N,store:se(l),to:"a"});u=[Z({fn:function(e){return e}}),p,X({fn:s})],xe(p,c.reg)}else u=[Z({fn:s})];return ge(a,[f]),c.scope.effect=a,c.meta.onCopy.push("effect"),(r=c.seq).splice.apply(r,[0,1].concat(u)),tr(a,f,"effect"),f},exports.clearNode=Xe,exports.combine=m,exports.createApi=function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];var t=Ve(r),a=t[0],o=a[0],i=a[1],u=t[1],f={};return c(i,(function(e,r){var n=f[r]=p(r,{parent:ve(o),config:u});o.on(n,e),tr(o,n)})),f},exports.createDomain=function e(r,n){var t=new Set,a=new Set,i=new Set,u=new Set,f=o({family:{type:"domain"},regional:1}),s={history:{domains:t,stores:a,effects:i,events:u},graphite:f};f.meta=ar("domain",s,n,r);var l=['onEvent','onEffect','onStore','onDomain'].map(or),m=l[0],v=l[1],g=l[2],y=l[3];s.hooks={event:m,effect:v,store:g,domain:y},s.onCreateEvent=dr(m,u,s),s.onCreateEffect=dr(v,i,s),s.onCreateStore=dr(g,a,s),s.onCreateDomain=dr(y,t,s),s.createEvent=s.event=function(e,r){return m(p(e,{parent:s,config:r}))},s.createEffect=s.effect=function(e,r){return v(h(e,{parent:s,config:r}))},s.createDomain=s.domain=function(r,n){return e({name:r,parent:s,config:n})},s.createStore=s.store=function(e,r){return g(d(e,{parent:s,config:r}))};var b=ve(s);return b&&(c(s.hooks,(function(e,r){er({from:e,to:b.hooks[r]})})),b.hooks.domain(s)),s},exports.createEffect=h,exports.createEvent=p,exports.createNode=o,exports.createStore=d,exports.createStoreObject=m,exports.fork=function(e,r){var n=void 0===r?{}:r,t=n.values,a=n.handlers;D(e)||M('first argument of fork should be domain');var i=!!t;t=w(t||{},(function(e){return!F(e)&&M('Values map can contain only stores as keys')}));var u,f,l,p,d,m,v=function(e){function r(e){var r=ue(e),t=n.indexOf(r);if(-1===t){var a='unit';e!==r&&e.id!==e.shortName&&(a=e.shortName),M(a+" not found in forked scope")}return p[t]}var n=S(e),t=new Map,a=new Set,i=X({fn:function(e,r,n){return(!n.node.meta.isCombine||ve(n)&&'combine'!==ve(n).node.meta.op)&&a.add(n.node.meta.forkOf.id),e}}),u=o({scope:{defers:[],inFlight:0,fxID:0},node:[X({fn:function(e,r,n){n.parent?'finally'===n.parent.node.meta.named?r.inFlight-=1:(r.inFlight+=1,r.fxID+=1):r.fxID+=1}}),K({priority:"sampler"}),Z({fn:function(e,r){var n=r.defers,t=r.fxID;r.inFlight>0||0===n.length||Promise.resolve().then((function(){r.fxID===t&&s(n.splice(0,n.length),(function(e){Ee(e.parentFork),e.rs(e.value)}))}))}})],meta:{unit:"forkInFlightCounter"}}),f={},l={},p=n.map((function(e){var r=e.next,n=e.meta,t=e.scope,a=o({node:e.seq.map((function(e){return{id:e.id,type:e.type,data:Object.assign({},e.data),hasRef:e.hasRef}})),child:[].concat(r),meta:Object.assign({forkOf:e},n),scope:Object.assign({},t)});return a.family={type:e.family.type,links:[].concat(ce(e)),owners:[].concat(fe(e))},f[e.id]=a,n.sid&&(l[n.sid]=a),a})),d={};return s(p,(function(e){var n=e.reg,a=e.scope,o=e.meta,f=o.onCopy,l=o.op,p=o.unit;switch(c(n,(function(e,r){var a=t.get(e);a||t.set(e,a={id:e.id,current:e.current}),d[r]=n[r]=a})),f&&s(f,(function(e){var n=a[e];a[e]=Array.isArray(n)?n.map(r):r(n)})),A(e,(function(e,n,t){t[n]=r(e)})),l||p){case N:e.meta.wrapped=function(e){return{kind:N,getState:function(){return e.reg[e.scope.state.id].current},updates:{watch:G(rr,e)},graphite:e,family:e.family}}(e),e.meta.sid&&e.seq.push(i);break;case"effect":e.next.push(u);break;case'fx':a.finally.next.push(u)}})),{cloneOf:e,changedStores:a,nodeMap:f,sidMap:l,clones:p,find:r,reg:d,getState:function(e){return r(e).meta.wrapped.getState()},graphite:o({family:{type:"domain",links:[u].concat(p)},meta:{unit:'fork'},scope:{forkInFlightCounter:u}})}}(e);if(i&&(u=S(e),f={},l={},p=new Set,d=new Set,m=Object.getOwnPropertyNames(t),s(u,(function(e){var r=e.meta.nativeTemplate;c(e.reg,(function(e,n){f[n]=e,r&&d.add(n)}))})),s(v.clones,(function(e){var r=e.reg,n=e.meta,a=n.sid;if(n.unit===N&&a&&$e(m,a)){var o=e.scope.state;r[o.id].current=t[a],p.add(o),v.changedStores.add(e.meta.forkOf.id)}c(r,(function(e,r){l[r]=e}))})),s(x(k(f),d),(function(e){(function(e,r){var n=0;if(r&&r.before&&!p.has(e)&&s(r.before,(function(r){switch(r.type){case j:e.current=r.fn(l[r.from.id].current);break;case'field':var t=l[r.from.id];n||(n=1,e.current=Array.isArray(e.current)?[].concat(e.current):Object.assign({},e.current)),e.current[r.field]=t.current}})),r&&r.after){var t=e.current;s(r.after,(function(e){var r=l[e.to.id];switch(e.type){case'copy':r.current=t;break;case j:r.current=e.fn(t)}}))}})(l[e],f[e])}))),a){a=w(a,(function(e){return!_(e)&&M("Handlers map can contain only effects as keys")}));var h=Object.keys(a);s(v.clones,(function(e){var r=e.scope,n=e.meta;n.sid&&$e(h,n.sid)&&(r.runner.scope.getHandler=function(){return a[n.sid]})}))}return v},exports.forward=er,exports.fromObservable=function(e){T(e);var r=q in e?e[q]():e;r.subscribe||M('expect observable to have .subscribe');var n=p(),t=V(Xe,n,void 0);return r.subscribe({next:n,error:t,complete:t}),n},exports.guard=function(){for(var e={op:'guard'},r='guard',n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];var u=Ve(a),f=u[0],c=f[0],s=f[1],l=u[1];l&&(e.config=l,l.name&&(r=l.name)),s||(c=(s=c).source);var d=s,v=d.filter,h=d.greedy,y=d.clock,k=d.name,w=void 0===k?r:k,x=s.target||p(w,e.config),S=C(v),A=1;return void 0===c&&(t(y,'guard','clock'),Array.isArray(y)&&(y=g(y)),c=y,A=0),A&&!C(c)&&(c=m(c)),y&&(t(y,'guard','clock'),c=b({source:c,clock:y,greedy:h,fn:S?null:function(e,r){return{source:e,clock:r}}})),t(x,'guard','target'),S?b({source:v,clock:c,target:o({node:[Y({fn:function(e){return e.guard}}),X({fn:function(e){return e.data}})],child:x,meta:e,family:{owners:[c,v,x].concat([].concat(y||[])),links:x},regional:1}),fn:function(e,r){return{guard:e,data:r}},greedy:h,name:w}):(z(v)||M('`filter` should be function or unit'),Ze(c,x,{scope:{fn:v},node:y?[Y({fn:function(e,r){return(0,r.fn)(e.source,e.clock)}}),X({fn:function(e){return e.source}})]:[Y({fn:ie})],meta:e})),x},exports.hydrate=function(e,r){var n=r.values,t=E(e)&&e.cloneOf;D(e)||t||M('first argument of hydrate should be domain or scope'),E(n)||M('values property should be an object');var a,o,u=w(n);if(t)a=[],o=[],c(u,(function(r,n){var t=e.sidMap[n];t&&(a.push(t),o.push(r),e.changedStores.add(t.meta.forkOf.id))}));else{var f=function(e){var r=e.flatGraphUnits,n=e.values,t=e.collectWatches,a=[],o=[],i={},u=new Set,f=Object.getOwnPropertyNames(n);return s(r,(function(e){var r=e.reg,s=e.meta,l=s.op,p=s.sid;if(s.unit===N&&p&&$e(f,p)){var d=e.scope.state;d.current=n[p],u.add(d)}if(t&&'watch'===l){var m=e.family.owners[0];m.meta.unit===N&&(a.push(e),o.push(m.scope.state))}c(r,(function(e,r){i[r]=e}))})),s(x(k(i)),(function(e){(function(e){var r=0;if(e.before&&!u.has(e)&&s(e.before,(function(n){switch(n.type){case j:e.current=n.fn(n.from.current);break;case'field':var t=n.from;r||(r=1,e.current=Array.isArray(e.current)?[].concat(e.current):Object.assign({},e.current)),e.current[n.field]=t.current}})),e.after){var n=e.current;s(e.after,(function(e){var r=e.to;switch(e.type){case'copy':r.current=n;break;case j:r.current=e.fn(n)}}))}})(i[e])})),{storeWatches:a,storeWatchesRefs:o}}({flatGraphUnits:S(e),values:u,collectWatches:1});a=f.storeWatches,o=f.storeWatchesRefs.map((function(e){return e.current}))}i({target:a,params:o,forkPage:t?e:0})},exports.is=I,exports.launch=i,exports.merge=g,exports.restore=function(e,r,n){if(F(e))return e;if(C(e)){var t,a=ve(e);return R(e)&&(t=d(r,{parent:a,name:e.shortName,"ɔ":n}).on(e,(function(e,r){return r}))),_(e)&&(t=d(r,{parent:a,name:e.shortName,"ɔ":n}).on(e.done,(function(e,r){return r.result}))),a&&a.hooks.store(t),t}var o=Array.isArray(e)?[]:{};return c(e,(function(e,r){o[r]=F(e)?e:d(e,{name:r})})),o},exports.sample=b,exports.scopeBind=function(e){je||M('scopeBind cannot be called outside of forked .watch');var r=je,n=je.find(e);return _(e)?function(e){var t=v();i({target:n,params:{params:e,req:t},forkPage:r})}:function(e){return i({target:n,params:e,forkPage:r}),e}},exports.serialize=function(e,r){var n=e.changedStores,t=void 0===r?{}:r,a=t.ignore,o=void 0===a?[]:a,i=t.onlyChanges,u={};return s(e.clones,(function(e){var r=e.meta,t=e.scope,a=e.reg;if(r.unit===N){var o=r.sid;o&&(!i&&!r.isCombine||n.has(r.forkOf.id))&&(u[o]=a[t.state.id].current)}})),s(o,(function(e){var r=e.sid;r&&delete u[r]})),u},exports.setStoreName=function(e,r){var n=f(r,ve(e));if(e.shortName=r,e.compositeName){var t=e.compositeName;t.path=n.path,t.shortName=n.shortName,t.fullName=n.fullName}else e.compositeName=n},exports.split=function(){for(var e,r=arguments.length,n=new Array(r),t=0;t<r;t++)n[t]=arguments[t];var a=Ve(n),i=a[0],u=i[0],f=i[1],s=a[1],l=!f;l&&(e=u.cases,f=u.match,u=u.source);var d=F(f),m=!C(f)&&z(f),v=!d&&!m&&E(f);e||(e={}),l||(v||M('match should be an object'),c(f,(function(r,n){e[n]=p(s)})),e.__=p(s));var h,g=be(),y=new Set([].concat(u,Object.values(e))),b=Object.keys(d||m?e:f);if(d||m)d&&y.add(f),h=[d&&K({priority:'sampler'}),d&&L({store:se(f),to:'a'}),Y({fn:function(e,r,n){var t=String(d?n.a:f(e));vr(r,$e(b,t)?t:'__',e,n)}})];else if(v){var k=ne({});k.type='shape';var w,x=k.before=[],S=[L({store:k,to:"a"}),X({fn:function(e,r,n){n.a[r.key]=e}})],A=[];c(f,(function(e,r){if(C(e)){w=1,A.push(r),y.add(e);var n=Ze(e,[],{node:S,scope:{key:r}});if(F(e)){k.current[r]=e.getState();var t=se(e);x.push({type:'field',field:r,from:t}),g&&($e(g.plain,t)||n.seq.unshift(g.loader))}}})),w&&g&&g.plain.push(k),h=[w&&K({priority:'sampler'}),w&&L({store:k,to:'a'}),Y({fn:function(e,r,n){for(var t=0;t<b.length;t++){var a=b[t];if($e(A,a)?n.a[a]:f[a](e))return void vr(r,a,e,n)}vr(r,'__',e,n)}})]}else M('expect match to be unit, function or object');if(o({meta:{onCopy:Object.keys(e),op:'split'},parent:u,scope:e,node:h,family:{type:'crosslink',owners:Array.from(y)},regional:1}),!l)return e},exports.step=re,exports.version="21.8.12",exports.withFactory=function(e){var r=e.name,n=e.loc,t=e.method,i=e.fn;return a(o({meta:{sidRoot:ke(e.sid),name:r,loc:n,method:t}}),i)},exports.withRegion=a;
//# sourceMappingURL=compat.js.map
