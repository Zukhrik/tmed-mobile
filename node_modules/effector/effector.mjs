function e(e,t,r,a){(V(e)||J(e))&&('family'in e||'graphite'in e)||B(`${t}: expect ${r} to be a unit (store, event or effect)${a}`)}function t(t,r,a){if(Array.isArray(t))for(let n=0;n<t.length;n++)e(t[n],r,`${n} item of ${a}`,'');else e(t,r,a,' or array of units')}function r(e,t){let r=ge(e).meta;Ce={parent:Ce,value:e,template:r.template||je(),sidRoot:r.sidRoot||Ce&&Ce.sidRoot};try{return t()}finally{Ce=xe(Ce)}}function a({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:o,child:s=n||o,scope:l={},meta:i={},family:f={type:'regular'},regional:c}={}){let u=Fe(a),p=Fe(f.links),d=Fe(f.owners),m=[],h={};for(let t=0;t<e.length;t++){let r=e[t];r&&(m.push(r),Re(r,h))}let g={id:Y(),seq:m,next:Fe(s),meta:i,scope:l,family:{type:f.type||"crosslink",links:p,owners:d},reg:h};for(let e=0;e<p.length;e++)ye(p[e]).push(g);for(let e=0;e<d.length;e++)ke(d[e]).push(g);for(let e=0;e<u.length;e++)u[e].next.push(g);return c&&Ce&&Ae(Se(Ce),[g]),g}function n(e,t,r){let a=Be,n=null,o=He;if(e.target&&(t=e.params,r=e.defer,a='page'in e?e.page:a,e.stack&&(n=e.stack),o=Ne(e)||o,e=e.target),o&&He&&o!==He&&(He=null),Array.isArray(e))for(let r=0;r<e.length;r++)Ee('pure',a,ge(e[r]),n,t[r],o);else Ee('pure',a,ge(e),n,t,o);if(r&&!Ge)return;let s,l,i,f,c,u,p={isRoot:Ge,currentPage:Be,forkPage:He,isWatch:Ue};Ge=0;e:for(;f=$e();){let{idx:e,stack:t,type:r}=f;i=t.node,Be=c=t.page,He=Ne(t),u=(c||i).reg;let a={fail:0,scope:i.scope};s=l=0;for(let n=e;n<i.seq.length&&!s;n++){let o=i.seq[n],f=o.data;switch(o.type){case"barrier":{let a=f.barrierID;c&&(a=`${c.fullID}_${a}`);let o=f.priority;if(n!==e||r!==o){Te.has(a)||(Te.add(a),ze(n,t,o,a));continue e}Te.delete(a);break}case'mov':{let e;switch(f.from){case"stack":e=Se(t);break;case"a":case'b':e=t[f.from];break;case"value":e=f.store;break;case I:u[f.store.id]||(t.page=c=Ke(c,f.store.id),u=c?c.reg:i.reg),e=pe(u[f.store.id])}switch(f.to){case"stack":t.value=e;break;case"a":case'b':t[f.to]=e;break;case I:Le(c,i,f.target.id).current=e}break}case'check':switch(f.type){case'defined':l=void 0===Se(t);break;case'changed':l=Se(t)===pe(Le(c,i,f.store.id))}break;case"filter":l=!Qe(a,f,t);break;case'run':if(n!==e||"effect"!==r){ze(n,t,"effect");continue e}case'compute':Ue='watch'===i.meta.op,t.value=Qe(a,f,t),Ue=p.isWatch}s=a.fail||l}if(!s)for(let e=0;e<i.next.length;e++)Ee('child',c,i.next[e],t,Se(t),Ne(t))}Ge=p.isRoot,Be=p.currentPage,He=Ne(p)}function o(e,t="combine"){let r=t+'(',a='',n=0;for(let t in e){let o=e[t];if(null!=o&&(r+=a,r+=E(o)?o.compositeName.fullName:o.toString()),n+=1,25===n)break;a=', '}return r+=')',r}function s(e,t){let r=l(t,xe(e));if(e.shortName=t,!e.compositeName)return void(e.compositeName=r);let a=e.compositeName;a.path=r.path,a.shortName=r.shortName,a.fullName=r.fullName}function l(e,t){let r,a,n,o=e;return t?(n=t.compositeName,0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)):(r=0===e.length?[]:[e],a=e),{shortName:o,fullName:a,path:r}}function i(e,t){for(let r in e)t(e[r],r)}function f(e,t){e.forEach(t)}function c(e,t){let r=(e,...t)=>Be?((e,t,r,a)=>{let n=Be,o=null;if(t)for(o=Be;o&&o.template!==t;)o=xe(o);Je(o);let s=e.create(r,a);return Je(n),s})(r,o,e,t):r.create(e,t);r.graphite=a({meta:ht("event",r,t,e),regional:1}),r.create=e=>(n(He?He.find(r):r,e),e),r.watch=Z(ut,r),r.map=e=>{let t,a;V(e)&&(t=e,a=e.name,e=e.fn);let n=c(Ye(r,a),t);return yt(r,n,$,e),n},r.filter=e=>kt(r,"filter",e.fn?e:e.fn,[le({fn:he})]),r.filterMap=e=>kt(r,'filterMap',e,[se({fn:he}),oe.defined()]),r.prepend=e=>{let t=c('* → '+r.shortName,{parent:xe(r)}),a=je();return a&&ge(t).seq.push(a.upward),yt(t,r,'prepend',e),mt(r,t),t};let o=je();return r}function u(e,r){function o(e,t){p.off(e),qe(p).set(e,lt(bt(e,p,'on',1,t,m)))}let s=ue(e),l=ue(e),i=gt('updates'),f=je();s.after=[{type:'copy',to:l}],f&&f.plain.push(s,l);let c=s.id,p={subscribers:new Map,updates:i,defaultState:e,stateRef:s,getState(){let e,t=s;if(Be){let t=Be;for(;t&&!t.reg[c];)t=xe(t);t&&(e=t)}return!e&&He&&He.reg[c]&&(e=He),e&&(t=e.reg[c]),pe(t)},setState(e){let t;He&&(t=He.nodeMap[ge(p).id]),t||(t=p),n({target:t,params:e,defer:1})},reset(...e){for(let t of e)p.on(t,(()=>p.defaultState));return p},on(e,r){if(t(e,'.on','first argument'),Array.isArray(e))for(let t of e)o(t,r);else o(e,r);return p},off(e){let t=qe(p).get(e);return t&&(t(),qe(p).delete(e)),p},map(e,t){let r,a,n;V(e)&&(r=e,a=e.name,t=e.firstState,e=e.fn);let o=p.getState(),l=je();l?n=null:void 0!==o&&(n=e(o,t));let i=u(n,{name:Ye(p,a),config:r,strict:0}),f=bt(p,i,$,0,e);return be(i).before=[{type:$,fn:e,from:s}],l&&(tt(l.plain,s)||tt(f.seq,l.loader)||f.seq.unshift(l.loader)),i},watch(e,t){if(!t||!E(e)){let t=ut(p,e),r=je();return r?r.watch.push({of:s,fn:e}):e(p.getState()),t}return J(t)||B('second argument should be a function'),e.watch((e=>t(p.getState(),e)))}},d=ht(I,p,r),m=p.defaultConfig.updateFilter;return p.graphite=a({scope:{state:s},node:[oe.defined(),oe.changed({store:l}),m&&ne({store:l,to:"a"}),m&&le({fn:(e,t,{a:r})=>m(e,r)}),fe({store:s}),fe({store:l})],child:i,meta:d,regional:1}),dt&&void 0===e&&B("current state can't be undefined, use null instead"),Ae(p,[i]),p}function p(...e){let t,r,a;Ze(e[0],((t,r)=>{a=t,e=r}));let n,o,s=e[e.length-1];if(J(s)?(r=e.slice(0,-1),t=s):r=e,1===r.length){let e=r[0];W(e)||(n=e,o=1)}return o||(n=r,t&&(t=vt(t))),V(n)||B('shape should be an object'),wt(Array.isArray(n),n,a,t)}function d(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function m(e,t){let r=c(e,t),o=r.defaultConfig.handler||(()=>B(`no handler used in ${r.getType()}`)),s=ge(r);s.meta.onCopy=['runner'],s.meta.unit=r.kind="effect",r.use=e=>(J(e)||B('.use argument should be a function'),o=e,r);let l=r.finally=gt('finally'),i=r.done=l.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),f=r.fail=l.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),p=r.doneData=i.map({named:'doneData',fn:({result:e})=>e}),m=r.failData=f.map({named:'failData',fn:({error:e})=>e}),h=a({scope:{getHandler:r.use.getCurrent=()=>o,finally:l},node:[ie({fn({params:e,req:t},{finally:r,getHandler:a},n){let o,s=St({params:e,req:t,ok:1,anyway:r,stack:n}),l=St({params:e,req:t,ok:0,anyway:r,stack:n});try{o=a()(e)}catch(e){return void l(e)}V(o)&&J(o.then)?o.then(s,l):s(o)}})],meta:{op:'fx',fx:'runner',onCopy:['finally']}});s.scope.runner=h,s.seq.push(se({fn:(e,t,r)=>xe(r)?{params:e,req:{rs(e){},rj(e){}}}:e}),ie({fn:(e,{runner:t},r)=>(n({target:t,params:e,defer:1,forkPage:Ne(r)}),e.params)})),r.create=e=>{let t=d(),a={params:e,req:t};if(He){if(!Ue){let e=He;t.req.finally((()=>{Ve(e)})).catch((()=>{}))}n(He.find(r),a)}else n(r,a);return t.req};let g=r.inFlight=u(0,{named:'inFlight'}).on(r,(e=>e+1)).on(l,(e=>e-1)),y=r.pending=g.map({fn:e=>e>0,named:'pending'});return Ae(r,[l,i,f,p,m,y,g,h]),r}function h(e){let t;Ze(e,((r,a)=>{t=r,e=a}));let{source:r,effect:a,mapParams:o}=e;o||(o=r?(e,t)=>t:e=>e);let s,l=m(e,t),{runner:i}=ge(l).scope,f=({params:e,req:t},{finally:r,effect:a},s)=>{let l,i=St({params:e,req:t,ok:0,anyway:r,stack:s});try{l=o(e,s.a)}catch(e){return i(e)}n({target:a,params:{params:l,req:{rs:St({params:e,req:t,ok:1,anyway:r,stack:s}),rj:i}},page:s.page,defer:1})};if(r){let e;W(r)?(e=r,Ae(r,[l])):(e=p(r),Ae(l,[e]));let t=ne({from:I,store:be(e),to:"a"});s=[ie({fn:e=>e}),t,se({fn:f})],Re(t,i.reg)}else s=[ie({fn:f})];return Ae(a,[l]),i.scope.effect=a,i.meta.onCopy.push("effect"),i.seq.splice(0,1,...s),mt(a,l,"effect"),l}function g(...e){let[[t,r],a]=et(e),n={};return i(r,((e,r)=>{let o=n[r]=c(r,{parent:xe(t),config:a});t.on(o,e),mt(t,o)})),n}function y(e,t){let r=new Set,n=new Set,o=new Set,s=new Set,l=a({family:{type:"domain"},regional:1}),f={history:{domains:r,stores:n,effects:o,events:s},graphite:l};l.meta=ht("domain",f,t,e);let[p,d,h,g]=['onEvent','onEffect','onStore','onDomain'].map(gt);f.hooks={event:p,effect:d,store:h,domain:g},f.onCreateEvent=xt(p,s,f),f.onCreateEffect=xt(d,o,f),f.onCreateStore=xt(h,n,f),f.onCreateDomain=xt(g,r,f),f.createEvent=f.event=(e,t)=>p(c(e,{parent:f,config:t})),f.createEffect=f.effect=(e,t)=>d(m(e,{parent:f,config:t})),f.createDomain=f.domain=(e,t)=>y({name:e,parent:f,config:t}),f.createStore=f.store=(e,t)=>h(u(e,{parent:f,config:t}));let k=xe(f);return k&&(i(f.hooks,((e,t)=>{ct({from:e,to:k.hooks[t]})})),k.hooks.domain(f)),f}function k(e){K(e);let t=_ in e?e[_]():e;t.subscribe||B('expect observable to have .subscribe');let r=c(),a=ee(st,r,void 0);return t.subscribe({next:r,error:a,complete:a}),r}function b(e,r){let a=c(r||o(e,'merge'));return t(e,'merge','first argument'),ct({from:e,to:a,meta:{op:'merge'}}),a}function v(...e){let r,n,o,s,[[l,i,d],m]=et(e);void 0===i&&V(l)&&(e=>{let t=0;return f(Nt,(r=>{r in e&&(null==e[r]&&B(`sample: ${r} should be defined`),t=1)})),t})(l)&&(i=l.clock,d=l.fn,s=l.greedy,r=l.target,n=l.name,o=l.sid,l=l.source);let h=1;void 0===l&&(t(i,'sample','clock'),Array.isArray(i)&&(i=b(i)),l=i,h=0),h&&!E(l)&&(l=p(l)),void 0===i&&(i=l),t(i,'sample','clock'),n=m||n||l.shortName;let g=je(),y=!!r;r||(W(l)&&W(i)?r=u(d?d(pe(be(l)),pe(be(i))):pe(be(l)),{name:n,sid:o}):(r=c(n),g&&ge(r).seq.push(g.loader)));let k=y&&E(r)&&ge(r).meta.nativeTemplate;if(W(l)){let e=be(l);Ae(l,[ft(i,r,{scope:{fn:d,targetTemplate:k},node:[g&&g.loader,!s&&ae({priority:"sampler"}),ne({store:e,to:d?"a":"stack"}),d&&se({fn:me}),g&&y&&g.upward],meta:{op:"sample",sample:I}})]),g&&(tt(g.plain,e)||tt(g.closure,e)||g.closure.push(e))}else{let e=ue(0),t=ue(),n=ue();g&&g.plain.push(e,t,n),a({parent:l,node:[fe({store:t}),ne({from:"value",store:1,target:e})],family:{owners:[l,r,i],links:r},meta:{op:"sample",sample:'source'},regional:1}),Ae(l,[ft(i,r,{scope:{fn:d,targetTemplate:k},node:[g&&g.loader,fe({store:n}),ne({store:e}),le({fn:e=>e}),!s&&ae({priority:"sampler"}),ne({store:t}),ne({store:n,to:"a"}),d&&se({fn:de}),g&&y&&g.upward],meta:{op:"sample",sample:'clock'}})])}return r}function w(...e){let r={op:'guard'},n='guard',[[o,s],l]=et(e);l&&(r.config=l,l.name&&(n=l.name)),s||(s=o,o=s.source);let{filter:i,greedy:f,clock:u,name:d=n}=s,m=s.target||c(d,r.config),h=E(i),g=1;return void 0===o&&(t(u,'guard','clock'),Array.isArray(u)&&(u=b(u)),o=u,g=0),g&&!E(o)&&(o=p(o)),u&&(t(u,'guard','clock'),o=v({source:o,clock:u,greedy:f,fn:h?null:(e,t)=>({source:e,clock:t})})),t(m,'guard','target'),h?v({source:i,clock:o,target:a({node:[le({fn:({guard:e})=>e}),se({fn:({data:e})=>e})],child:m,meta:r,family:{owners:[o,i,m,...[].concat(u||[])],links:m},regional:1}),fn:(e,t)=>({guard:e,data:t}),greedy:f,name:d}):(J(i)||B('`filter` should be function or unit'),ft(o,m,{scope:{fn:i},node:u?[le({fn:({source:e,clock:t},{fn:r})=>r(e,t)}),se({fn:({source:e})=>e})]:[le({fn:he})],meta:r})),m}function S(e,t,r){if(W(e))return e;if(E(e)){let a,n=xe(e);return T(e)&&(a=u(t,{parent:n,name:e.shortName,ɔ:r}).on(e,((e,t)=>t))),H(e)&&(a=u(t,{parent:n,name:e.shortName,ɔ:r}).on(e.done,((e,{result:t})=>t))),n&&n.hooks.store(a),a}let a=Array.isArray(e)?[]:{};return i(e,((e,t)=>{a[t]=W(e)?e:u(e,{name:t})})),a}function q(...e){let t,[[r,n],o]=et(e),s=!n;s&&(t=r.cases,n=r.match,r=r.source);let l=W(n),f=!E(n)&&J(n),u=!l&&!f&&V(n);t||(t={}),s||(u||B('match should be an object'),i(n,((e,r)=>{t[r]=c(o)})),t.__=c(o));let p,d=je(),m=new Set([].concat(r,Object.values(t))),h=Object.keys(l||f?t:n);if(l||f)l&&m.add(n),p=[l&&ae({priority:'sampler'}),l&&ne({store:be(n),to:'a'}),le({fn(e,t,r){let a=String(l?r.a:n(e));At(t,tt(h,a)?a:'__',e,r)}})];else if(u){let e=ue({});e.type='shape';let t,r=e.before=[],a=[ne({store:e,to:"a"}),se({fn(e,{key:t},{a:r}){r[t]=e}})],o=[];i(n,((n,s)=>{if(E(n)){t=1,o.push(s),m.add(n);let l=ft(n,[],{node:a,scope:{key:s}});if(W(n)){e.current[s]=n.getState();let t=be(n);r.push({type:'field',field:s,from:t}),d&&(tt(d.plain,t)||l.seq.unshift(d.loader))}}})),t&&d&&d.plain.push(e),p=[t&&ae({priority:'sampler'}),t&&ne({store:e,to:'a'}),le({fn(e,t,r){for(let a=0;a<h.length;a++){let s=h[a];if(tt(o,s)?r.a[s]:n[s](e))return void At(t,s,e,r)}At(t,'__',e,r)}})]}else B('expect match to be unit, function or object');if(a({meta:{onCopy:Object.keys(t),op:'split'},parent:r,scope:t,node:p,family:{type:'crosslink',owners:Array.from(m)},regional:1}),!s)return t}function x(e,{values:t}){let r=V(e)&&e.cloneOf;G(e)||r||B('first argument of hydrate should be domain or scope'),V(t)||B('values property should be an object');let a,o,s=j(t);if(r)a=[],o=[],i(s,((t,r)=>{let n=e.sidMap[r];n&&(a.push(n),o.push(t),e.changedStores.add(n.meta.forkOf.id))}));else{let t=(({flatGraphUnits:e,values:t,collectWatches:r})=>{let a=[],n=[],o={},s=new Set,l=Object.getOwnPropertyNames(t);return f(e,(e=>{let{reg:f}=e,{op:c,unit:u,sid:p}=e.meta;if(u===I&&p&&tt(l,p)){let{state:r}=e.scope;r.current=t[p],s.add(r)}if(r&&'watch'===c){let t=e.family.owners[0];t.meta.unit===I&&(a.push(e),n.push(t.scope.state))}i(f,((e,t)=>{o[t]=e}))})),f(P(N(o)),(e=>{(e=>{let t=0;if(e.before&&!s.has(e)&&f(e.before,(r=>{switch(r.type){case $:e.current=r.fn(r.from.current);break;case'field':{let a=r.from;t||(t=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[r.field]=a.current;break}}})),!e.after)return;let r=e.current;f(e.after,(e=>{let t=e.to;switch(e.type){case'copy':t.current=r;break;case $:t.current=e.fn(r)}}))})(o[e])})),{storeWatches:a,storeWatchesRefs:n}})({flatGraphUnits:R(e),values:s,collectWatches:1});a=t.storeWatches,o=t.storeWatchesRefs.map((({current:e})=>e))}n({target:a,params:o,forkPage:r?e:0})}function N(e){let t=Object.values(e),r={};return f(t,(({id:e})=>{r[e]=[]})),f(t,(({id:e,before:t,after:a})=>{t&&f(t,(t=>{r[t.from.id].push(e)})),a&&f(a,(t=>{r[e].push(t.to.id)}))})),r}function A({clones:e,changedStores:t},{ignore:r=[],onlyChanges:a}={}){let n={};return f(e,(({meta:e,scope:r,reg:o})=>{if(e.unit!==I)return;let{sid:s}=e;s&&(!a&&!e.isCombine||t.has(e.forkOf.id))&&(n[s]=o[r.state.id].current)})),f(r,(({sid:e})=>{e&&delete n[e]})),n}function C(e){He||B('scopeBind cannot be called outside of forked .watch');let t=He,r=He.find(e);return H(e)?e=>{let a=d();n({target:r,params:{params:e,req:a},forkPage:t})}:e=>(n({target:r,params:e,forkPage:t}),e)}function j(e,t=(()=>{})){if(e instanceof Map){let r={};for(let[a,n]of e)E(a)||B('Map key should be a unit'),t(a,n),r[a.sid]=n;return r}return e}function O(e,{values:t,handlers:r}={}){G(e)||B('first argument of fork should be domain');let n=!!t;t=j(t||{},(e=>!W(e)&&B('Values map can contain only stores as keys')));let o=(e=>{function t(e){let t=ge(e),a=r.indexOf(t);if(-1===a){let r='unit';e!==t&&e.id!==e.shortName&&(r=e.shortName),B(`${r} not found in forked scope`)}return p[a]}let r=R(e),n=new Map,o=new Set,s=se({fn:(e,t,r)=>((!r.node.meta.isCombine||xe(r)&&'combine'!==xe(r).node.meta.op)&&o.add(r.node.meta.forkOf.id),e)}),l=a({scope:{defers:[],inFlight:0,fxID:0},node:[se({fn(e,t,r){r.parent?'finally'===r.parent.node.meta.named?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1}}),ae({priority:"sampler"}),ie({fn(e,t){let{inFlight:r,defers:a,fxID:n}=t;r>0||0===a.length||Promise.resolve().then((()=>{t.fxID===n&&f(a.splice(0,a.length),(e=>{Ve(e.parentFork),e.rs(e.value)}))}))}})],meta:{unit:"forkInFlightCounter"}}),c={},u={},p=r.map((e=>{let{seq:t,next:r,meta:n,scope:o}=e,s=a({node:t.map((e=>({id:e.id,type:e.type,data:{...e.data},hasRef:e.hasRef}))),child:[...r],meta:{forkOf:e,...n},scope:{...o}});return s.family={type:e.family.type,links:[...ke(e)],owners:[...ye(e)]},c[e.id]=s,n.sid&&(u[n.sid]=s),s})),d={};return f(p,(e=>{let{reg:r,scope:a,meta:{onCopy:o,op:c,unit:u}}=e;switch(i(r,((e,t)=>{let a=n.get(e);a||(a={id:e.id,current:e.current},n.set(e,a)),d[t]=r[t]=a})),o&&f(o,(e=>{let r=a[e];a[e]=Array.isArray(r)?r.map(t):t(r)})),D(e,((e,r,a)=>{a[r]=t(e)})),c||u){case I:e.meta.wrapped=(e=>({kind:I,getState:()=>e.reg[e.scope.state.id].current,updates:{watch:Z(ut,e)},graphite:e,family:e.family}))(e),e.meta.sid&&e.seq.push(s);break;case M:e.next.push(l);break;case'fx':a.finally.next.push(l)}})),{cloneOf:e,changedStores:o,nodeMap:c,sidMap:u,clones:p,find:t,reg:d,getState:e=>t(e).meta.wrapped.getState(),graphite:a({family:{type:"domain",links:[l,...p]},meta:{unit:'fork'},scope:{forkInFlightCounter:l}})}})(e);if(n&&(()=>{let r=R(e),a={},n={},s=new Set,l=new Set,c=Object.getOwnPropertyNames(t);f(r,(({reg:e,meta:t})=>{let{nativeTemplate:r}=t;i(e,((e,t)=>{a[t]=e,r&&l.add(t)}))})),f(o.clones,(e=>{let{reg:r}=e,{unit:a,sid:l}=e.meta;if(a===I&&l&&tt(c,l)){let{state:a}=e.scope;r[a.id].current=t[l],s.add(a),o.changedStores.add(e.meta.forkOf.id)}i(r,((e,t)=>{n[t]=e}))})),f(P(N(a),l),(e=>{((e,t)=>{let r=0;if(t&&t.before&&!s.has(e)&&f(t.before,(t=>{switch(t.type){case $:e.current=t.fn(n[t.from.id].current);break;case'field':{let a=n[t.from.id];r||(r=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[t.field]=a.current;break}}})),!t||!t.after)return;let a=e.current;f(t.after,(e=>{let t=n[e.to.id];switch(e.type){case'copy':t.current=a;break;case $:t.current=e.fn(a)}}))})(n[e],a[e])}))})(),r){r=j(r,(e=>!H(e)&&B("Handlers map can contain only effects as keys")));let e=Object.keys(r);f(o.clones,(({scope:t,meta:a})=>{a.sid&&tt(e,a.sid)&&(t.runner.scope.getHandler=()=>r[a.sid])}))}return o}function P(e,t){function r(e){s[e]=1;let t=a[e];for(let e=0;e<t.length;e++){let a=t[e];s[a]||o[a]||r(a)}s[e]=0,o[e]=1,n.push(e)}let a={};for(let t in e)a[t]=[...new Set(e[t])];let n=[],o={},s={};for(let e in a)o[e]||s[e]||r(e);if(n.reverse(),t&&t.size>0){let e,r=[],o=[...t];for(;e=o.shift();)r.push(e),f(a[e],(e=>{tt(r,e)||tt(o,e)||o.push(e)}));f(r,(e=>{rt(n,e)}))}return n}function F(e,{scope:t,params:r}){if(!E(e))return Promise.reject(Error('first argument should be unit'));let a=d();a.parentFork=He;let{forkInFlightCounter:o}=t.graphite.scope;o.scope.defers.push(a);let s=[t.find(e)],l=[];return H(e)?l.push({params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}):l.push(r),s.push(o),l.push(null),n({target:s,params:l,forkPage:t}),a.req}function R(e){let t=[];return function e(r){tt(t,r)||(t.push(r),D(r,e))}(ge(e)),t}function D(e,t){let r=e.meta.unit;'fork'!==r&&"forkInFlightCounter"!==r&&(f(e.next,t),f(ye(e),t),f(ke(e),t))}let _='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',I='store',M='effect',$='map',E=e=>(J(e)||V(e))&&'kind'in e;const z=e=>t=>E(t)&&t.kind===e;let W=z(I),T=z("event"),H=z(M),G=z("domain");var U={__proto__:null,unit:E,store:W,event:T,effect:H,domain:G};let B=e=>{throw Error(e)},V=e=>'object'==typeof e&&null!==e,J=e=>'function'==typeof e,K=e=>{V(e)||J(e)||B('expect first argument be an object')};const L=()=>{let e=0;return()=>(++e).toString(36)};let Q=L(),X=L(),Y=L(),Z=(e,t)=>e.bind(null,t),ee=(e,t,r)=>e.bind(null,t,r);const te=(e,t,r)=>({id:X(),type:e,data:r,hasRef:t});let re=0,ae=({priority:e="barrier"})=>te("barrier",0,{barrierID:++re,priority:e}),ne=({from:e=I,store:t,target:r,to:a=(r?I:"stack")})=>te('mov',e===I,{from:e,store:t,to:a,target:r}),oe={defined:()=>te('check',0,{type:'defined'}),changed:({store:e})=>te('check',1,{type:'changed',store:e})},se=ee(te,'compute',0),le=ee(te,"filter",0),ie=ee(te,'run',0),fe=({store:e})=>ne({from:"stack",target:e});var ce={__proto__:null,barrier:ae,mov:ne,check:oe,compute:se,filter:le,run:ie,update:fe};let ue=e=>({id:X(),current:e}),pe=({current:e})=>e,de=(e,{fn:t},{a:r})=>t(e,r),me=(e,{fn:t},{a:r})=>t(r,e),he=(e,{fn:t})=>t(e),ge=e=>e.graphite||e,ye=e=>e.family.owners,ke=e=>e.family.links,be=e=>e.stateRef,ve=e=>e.config,we=e=>e.ɔ,Se=e=>e.value,qe=e=>e.subscribers,xe=e=>e.parent,Ne=e=>e.forkPage,Ae=(e,t)=>{let r=ge(e);for(let e=0;e<t.length;e++){let a=ge(t[e]);"domain"!==r.family.type&&(a.family.type="crosslink"),ye(a).push(r),ke(r).push(a)}},Ce=null,je=()=>Ce&&Ce.template,Oe=e=>(e&&Ce&&Ce.sidRoot&&(e=`${Ce.sidRoot}ɔ${e}`),e),Pe=({sid:e,name:t,loc:n,method:o,fn:s})=>r(a({meta:{sidRoot:Oe(e),name:t,loc:n,method:o}}),s);const Fe=(e=[])=>{let t=[];if(Array.isArray(e))for(let r=0;r<e.length;r++)Array.isArray(e[r])?t.push(...e[r]):t.push(e[r]);else t.push(e);return t.map(ge)};let Re=({hasRef:e,type:t,data:r},a)=>{let n;e&&(n=r.store,a[n.id]=n),'mov'===t&&r.to===I&&(n=r.target,a[n.id]=n)},De=null;const _e=(e,t)=>{if(!e)return t;if(!t)return e;let r,a=e.v.type===t.v.type;return(a&&e.v.id>t.v.id||!a&&"sampler"===e.v.type)&&(r=e,e=t,t=r),r=_e(e.r,t),e.r=e.l,e.l=r,e},Ie=[];let Me=0;for(;Me<5;)Ie.push({first:null,last:null,size:0}),Me+=1;const $e=()=>{for(let e=0;e<5;e++){let t=Ie[e];if(t.size>0){if(2===e||3===e){t.size-=1;let e=De.v;return De=_e(De.l,De.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Ee=(e,t,r,a,n,o)=>ze(0,{a:null,b:null,node:r,parent:a,value:n,page:t,forkPage:o},e),ze=(e,t,r,a=0)=>{let n=We(r),o=Ie[n],s={v:{idx:e,stack:t,type:r,id:a},l:0,r:0};2===n||3===n?De=_e(De,s):(0===o.size?o.first=s:o.last.r=s,o.last=s),o.size+=1},We=e=>{switch(e){case'child':return 0;case'pure':return 1;case"barrier":return 2;case"sampler":return 3;case M:return 4;default:return-1}},Te=new Set;let He,Ge=1,Ue=0,Be=null,Ve=e=>{He=e},Je=e=>{Be=e};const Ke=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=xe(e);if(e)return e}return null},Le=(e,t,r)=>(Ke(e,r)||t).reg[r],Qe=(e,{fn:t},r)=>{try{return t(Se(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let Xe=(e,t)=>''+e.shortName+t,Ye=(e,t)=>null==t?Xe(e,' → *'):t,Ze=(e,t)=>{K(e),we(e)&&t(ve(e),we(e))},et=e=>{let t;return Ze(e[0],((r,a)=>{t=r,e=a})),[e,t]},tt=(e,t)=>e.includes(t),rt=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)};const at=(e,t)=>{rt(e.next,t),rt(ye(e),t),rt(ke(e),t)},nt=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=ke(e);for(;a=n.pop();)at(a,e),(t||r&&!e.meta.sample||"crosslink"===a.family.type)&&nt(a,t,'on'!==a.meta.op&&r);for(n=ye(e);a=n.pop();)at(a,e),r&&"crosslink"===a.family.type&&nt(a,t,'on'!==a.meta.op&&r)},ot=e=>e.clear();let st=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),W(e))ot(qe(e));else if(G(e)){r=1;let t=e.history;ot(t.events),ot(t.effects),ot(t.stores),ot(t.domains)}nt(ge(e),!!t,r)},lt=e=>{let t=ee(st,e,void 0);return t.unsubscribe=t,t},ft=(e,t,{node:r,scope:n,meta:o})=>a({node:r,parent:e,child:t,scope:n,meta:o,family:{owners:[e,t],links:t},regional:1}),ct=e=>{let r;Ze(e,((t,a)=>{r=t,e=a}));let{from:n,to:o,meta:s={op:'forward'}}=e;return t(n,'forward','"from"'),t(o,'forward','"to"'),r&&(s.config=r),lt(a({parent:n,child:o,meta:s,family:{},regional:1}))},ut=(e,t)=>{if(J(t)||B('.watch argument should be a function'),He){let t=He.nodeMap[ge(e).id];t&&(e=t)}return lt(a({scope:{fn:t},node:[ie({fn:he})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))};const pt=(e,t)=>(V(e)&&(pt(ve(e),t),null!=e.name&&(V(e.name)?pt(e.name,t):J(e.name)?t.handler=e.name:t.name=e.name),e.loc&&(t.loc=e.loc),(e.sid||null===e.sid)&&(t.sid=e.sid),e.handler&&(t.handler=e.handler),e.updateFilter&&(t.updateFilter=e.updateFilter),xe(e)&&(t.parent=xe(e)),'strict'in e&&(t.strict=e.strict),e.named&&(t.named=e.named),pt(we(e),t)),t);let dt,mt=(e,t,r="event")=>{xe(e)&&xe(e).hooks[r](t)},ht=(e,t,r,a)=>{let n=pt({name:a,config:r},{}),o="domain"===e,s=Q(),{parent:i=null,sid:f=null,strict:c=1,named:u=null}=n,p=u||n.name||(o?'':s),d=l(p,i),m={unit:t.kind=e,name:t.shortName=p,sid:t.sid=Oe(f),named:u,unitId:t.id=s};if(t.parent=i,t.compositeName=d,t.defaultConfig=n,t.thru=e=>e(t),t.getType=()=>d.fullName,!o){t.subscribe=e=>(K(e),t.watch(J(e)?e:t=>{e.next&&e.next(t)})),t[_]=()=>t;let e=je();e&&(m.nativeTemplate=e)}return dt=c,m},gt=e=>c({named:e});const yt=(e,t,r,a)=>ft(e,t,{scope:{fn:a},node:[se({fn:he})],meta:{op:r}}),kt=(e,t,r,a)=>{let n;V(r)&&(n=r,r=r.fn);let o=c(Xe(e,' →? *'),n);return ft(e,o,{scope:{fn:r},node:a,meta:{op:t}}),o},bt=(e,t,r,a,n,o)=>{let s=be(t),l=[ne({store:s,to:"a"}),se({fn:a?me:de}),oe.defined(),oe.changed({store:s}),o&&le({fn:(e,t,{a:r})=>o(e,r)}),fe({store:s})],i=je();if(i&&(l.unshift(i.loader),l.push(i.upward),W(e))){let t=be(e);tt(i.plain,t)||(tt(i.closure,t)||i.closure.push(t),s.before||(s.before=[]),s.before.push({type:'closure',of:t}))}return ft(e,t,{scope:{fn:n},node:l,meta:{op:r}})},vt=e=>t=>e(...t),wt=(e,t,r,a)=>{let n=e?e=>e.slice():e=>({...e}),s=e?[]:{},l=je(),f=n(s),c=ue(f),p=ue(1);c.type=e?'list':'shape',l&&l.plain.push(c,p);let d=u(f,{name:r||o(t)});ge(d).meta.isCombine=1;let m=[oe.defined(),ne({store:c,to:"a"}),le({fn:(e,{key:t},{a:r})=>e!==r[t]}),ne({store:p,to:'b'}),se({fn(e,{clone:t,key:r},a){a.b&&(a.a=t(a.a)),a.a[r]=e}}),ne({from:"a",target:c}),ne({from:"value",store:0,target:p}),ae({priority:"barrier"}),ne({from:"value",store:1,target:p}),ne({store:c}),a&&se({fn:a}),oe.changed({store:be(d)})],h=c.before=[];return i(t,((e,t)=>{if(!W(e))return void(f[t]=s[t]=e);s[t]=e.defaultState,f[t]=e.getState();let r=ft(e,d,{scope:{key:t,clone:n},node:m,meta:{op:'combine'}}),a=be(e);h.push({type:'field',field:t,from:a}),l&&(tt(l.plain,a)||r.seq.unshift(l.loader))})),d.defaultShape=t,c.after=[a?{type:$,to:be(d),fn:a}:{type:'copy',to:be(d)}],l||(d.defaultState=a?be(d).current=a(f):s),d};let St=({params:e,req:t,ok:r,anyway:a,stack:o})=>s=>n({target:[a,qt],params:[r?{status:'done',params:e,result:s}:{status:'fail',params:e,error:s},{fn:r?t.rs:t.rj,value:s}],defer:1,page:o.page,forkPage:Ne(o)}),qt=a({node:[ie({fn({fn:e,value:t}){e(t)}})],meta:{op:'fx',fx:'sidechain'}});const xt=(e,t,r)=>(e.create=t=>(n(e,t),t),ge(e).seq.push(se({fn:(e,t,r)=>(r.forkPage=null,e)})),e.watch((e=>{Ae(r,[e]),t.add(e),e.ownerSet||(e.ownerSet=t),xe(e)||(e.parent=r)})),Ae(r,[e]),r=>(t.forEach(r),e.watch(r))),Nt=['source','clock','target'],At=(e,t,r,a)=>{let o=e[t];o&&n({target:o,params:Array.isArray(o)?o.map((()=>r)):r,defer:1,stack:a})},Ct="21.8.12";export{F as allSettled,h as attach,st as clearNode,p as combine,g as createApi,y as createDomain,m as createEffect,c as createEvent,a as createNode,u as createStore,p as createStoreObject,O as fork,ct as forward,k as fromObservable,w as guard,x as hydrate,U as is,n as launch,b as merge,S as restore,v as sample,C as scopeBind,A as serialize,s as setStoreName,q as split,ce as step,Ct as version,Pe as withFactory,r as withRegion};
//# sourceMappingURL=effector.mjs.map
