((e,t)=>{'object'==typeof exports&&'undefined'!=typeof module?t(exports):'function'==typeof define&&define.amd?define(['exports'],t):t((e='undefined'!=typeof globalThis?globalThis:e||self).effector={})})(this,(e=>{function t(e,t,r,a){(U(e)||V(e))&&('family'in e||'graphite'in e)||G(`${t}: expect ${r} to be a unit (store, event or effect)${a}`)}function r(e,r,a){if(Array.isArray(e))for(let n=0;n<e.length;n++)t(e[n],r,`${n} item of ${a}`,'');else t(e,r,a,' or array of units')}function a(e,t){let r=he(e).meta;Ae={parent:Ae,value:e,template:r.template||je(),sidRoot:r.sidRoot||Ae&&Ae.sidRoot};try{return t()}finally{Ae=xe(Ae)}}function n({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:o,child:l=n||o,scope:s={},meta:i={},family:f={type:'regular'},regional:c}={}){let u=Ce(a),p=Ce(f.links),d=Ce(f.owners),m=[],h={};for(let t=0;t<e.length;t++){let r=e[t];r&&(m.push(r),Pe(r,h))}let g={id:X(),seq:m,next:Ce(l),meta:i,scope:s,family:{type:f.type||O,links:p,owners:d},reg:h};for(let e=0;e<p.length;e++)ge(p[e]).push(g);for(let e=0;e<d.length;e++)ye(d[e]).push(g);for(let e=0;e<u.length;e++)u[e].next.push(g);return c&&Ae&&Ne(ve(Ae),[g]),g}function o(e,t,r){let a=Be,n=null,o=Te;if(e.target&&(t=e.params,r=e.defer,a='page'in e?e.page:a,e.stack&&(n=e.stack),o=qe(e)||o,e=e.target),o&&Te&&o!==Te&&(Te=null),Array.isArray(e))for(let r=0;r<e.length;r++)Ee('pure',a,he(e[r]),n,t[r],o);else Ee('pure',a,he(e),n,t,o);if(r&&!We)return;let l,s,i,f,c,u,p={isRoot:We,currentPage:Be,forkPage:Te,isWatch:He};We=0;e:for(;f=Me();){let{idx:e,stack:t,type:r}=f;i=t.node,Be=c=t.page,Te=qe(t),u=(c||i).reg;let a={fail:0,scope:i.scope};l=s=0;for(let n=e;n<i.seq.length&&!l;n++){let o=i.seq[n],f=o.data;switch(o.type){case R:{let a=f.barrierID;c&&(a=`${c.fullID}_${a}`);let o=f.priority;if(n!==e||r!==o){ze.has(a)||(ze.add(a),Ie(n,t,o,a));continue e}ze.delete(a);break}case'mov':{let e;switch(f.from){case P:e=ve(t);break;case E:case'b':e=t[f.from];break;case _:e=f.store;break;case x:u[f.store.id]||(t.page=c=Ve(c,f.store.id),u=c?c.reg:i.reg),e=ue(u[f.store.id])}switch(f.to){case P:t.value=e;break;case E:case'b':t[f.to]=e;break;case x:Je(c,i,f.target.id).current=e}break}case'check':switch(f.type){case'defined':s=void 0===ve(t);break;case'changed':s=ve(t)===ue(Je(c,i,f.store.id))}break;case M:s=!Ke(a,f,t);break;case'run':if(n!==e||r!==N){Ie(n,t,N);continue e}case'compute':He='watch'===i.meta.op,t.value=Ke(a,f,t),He=p.isWatch}l=a.fail||s}if(!l)for(let e=0;e<i.next.length;e++)Ee('child',c,i.next[e],t,ve(t),qe(t))}We=p.isRoot,Be=p.currentPage,Te=qe(p)}function l(e,t="combine"){let r=t+'(',a='',n=0;for(let t in e){let o=e[t];if(null!=o&&(r+=a,r+=I(o)?o.compositeName.fullName:o.toString()),n+=1,25===n)break;a=', '}return r+=')',r}function s(e,t){let r,a,n,o=e;return t?(n=t.compositeName,0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)):(r=0===e.length?[]:[e],a=e),{shortName:o,fullName:a,path:r}}function i(e,t){for(let r in e)t(e[r],r)}function f(e,t){e.forEach(t)}function c(e,t){let r=(e,...t)=>Be?((e,t,r,a)=>{let n=Be,o=null;if(t)for(o=Be;o&&o.template!==t;)o=xe(o);Ue(o);let l=e.create(r,a);return Ue(n),l})(r,a,e,t):r.create(e,t);r.graphite=n({meta:dt(q,r,t,e),regional:1}),r.create=e=>(o(Te?Te.find(r):r,e),e),r.watch=Y(ft,r),r.map=e=>{let t,a;U(e)&&(t=e,a=e.name,e=e.fn);let n=c(Qe(r,a),t);return ht(r,n,C,e),n},r.filter=e=>gt(r,M,e.fn?e:e.fn,[le({fn:me})]),r.filterMap=e=>gt(r,'filterMap',e,[oe({fn:me}),ne.defined()]),r.prepend=e=>{let t=c('* → '+r.shortName,{parent:xe(r)}),a=je();return a&&he(t).seq.push(a.upward),ht(t,r,'prepend',e),pt(r,t),t};let a=je();return r}function u(e,t){function a(e,t){p.off(e),Se(p).set(e,ot(yt(e,p,'on',1,t,m)))}let l=ce(e),s=ce(e),i=mt('updates'),f=je();l.after=[{type:'copy',to:s}],f&&f.plain.push(l,s);let c=l.id,p={subscribers:new Map,updates:i,defaultState:e,stateRef:l,getState(){let e,t=l;if(Be){let t=Be;for(;t&&!t.reg[c];)t=xe(t);t&&(e=t)}return!e&&Te&&Te.reg[c]&&(e=Te),e&&(t=e.reg[c]),ue(t)},setState(e){let t;Te&&(t=Te.nodeMap[he(p).id]),t||(t=p),o({target:t,params:e,defer:1})},reset(...e){for(let t of e)p.on(t,(()=>p.defaultState));return p},on(e,t){if(r(e,'.on','first argument'),Array.isArray(e))for(let r of e)a(r,t);else a(e,t);return p},off(e){let t=Se(p).get(e);return t&&(t(),Se(p).delete(e)),p},map(e,t){let r,a,n;U(e)&&(r=e,a=e.name,t=e.firstState,e=e.fn);let o=p.getState(),s=je();s?n=null:void 0!==o&&(n=e(o,t));let i=u(n,{name:Qe(p,a),config:r,strict:0}),f=yt(p,i,C,0,e);return ke(i).before=[{type:C,fn:e,from:l}],s&&(Ze(s.plain,l)||Ze(f.seq,s.loader)||f.seq.unshift(s.loader)),i},watch(e,t){if(!t||!I(e)){let t=ft(p,e),r=je();return r?r.watch.push({of:l,fn:e}):e(p.getState()),t}return V(t)||G('second argument should be a function'),e.watch((e=>t(p.getState(),e)))}},d=dt(x,p,t),m=p.defaultConfig.updateFilter;return p.graphite=n({scope:{state:l},node:[ne.defined(),ne.changed({store:s}),m&&ae({store:s,to:E}),m&&le({fn:(e,t,{a:r})=>m(e,r)}),ie({store:l}),ie({store:s})],child:i,meta:d,regional:1}),ut&&void 0===e&&G("current state can't be undefined, use null instead"),Ne(p,[i]),p}function p(...e){let t,r,a;Xe(e[0],((t,r)=>{a=t,e=r}));let n,o,l=e[e.length-1];if(V(l)?(r=e.slice(0,-1),t=l):r=e,1===r.length){let e=r[0];z(e)||(n=e,o=1)}return o||(n=r,t&&(t=kt(t))),U(n)||G('shape should be an object'),bt(Array.isArray(n),n,a,t)}function d(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function m(e,t){let r=c(e,t),a=r.defaultConfig.handler||(()=>G(`no handler used in ${r.getType()}`)),l=he(r);l.meta.onCopy=['runner'],l.meta.unit=r.kind=N,r.use=e=>(V(e)||G('.use argument should be a function'),a=e,r);let s=r.finally=mt('finally'),i=r.done=s.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),f=r.fail=s.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),p=r.doneData=i.map({named:'doneData',fn:({result:e})=>e}),m=r.failData=f.map({named:'failData',fn:({error:e})=>e}),h=n({scope:{getHandler:r.use.getCurrent=()=>a,finally:s},node:[se({fn({params:e,req:t},{finally:r,getHandler:a},n){let o,l=wt({params:e,req:t,ok:1,anyway:r,stack:n}),s=wt({params:e,req:t,ok:0,anyway:r,stack:n});try{o=a()(e)}catch(e){return void s(e)}U(o)&&V(o.then)?o.then(l,s):l(o)}})],meta:{op:'fx',fx:'runner',onCopy:['finally']}});l.scope.runner=h,l.seq.push(oe({fn:(e,t,r)=>xe(r)?{params:e,req:{rs(e){},rj(e){}}}:e}),se({fn:(e,{runner:t},r)=>(o({target:t,params:e,defer:1,forkPage:qe(r)}),e.params)})),r.create=e=>{let t=d(),a={params:e,req:t};if(Te){if(!He){let e=Te;t.req.finally((()=>{Ge(e)})).catch((()=>{}))}o(Te.find(r),a)}else o(r,a);return t.req};let g=r.inFlight=u(0,{named:'inFlight'}).on(r,(e=>e+1)).on(s,(e=>e-1)),y=r.pending=g.map({fn:e=>e>0,named:'pending'});return Ne(r,[s,i,f,p,m,y,g,h]),r}function h(e,t){let a=c(t||l(e,'merge'));return r(e,'merge','first argument'),st({from:e,to:a,meta:{op:'merge'}}),a}function g(...e){let t,a,o,l,[[s,i,d],m]=Ye(e);void 0===i&&U(s)&&(e=>{let t=0;return f(xt,(r=>{r in e&&(null==e[r]&&G(`sample: ${r} should be defined`),t=1)})),t})(s)&&(i=s.clock,d=s.fn,l=s.greedy,t=s.target,a=s.name,o=s.sid,s=s.source);let g=1;void 0===s&&(r(i,'sample','clock'),Array.isArray(i)&&(i=h(i)),s=i,g=0),g&&!I(s)&&(s=p(s)),void 0===i&&(i=s),r(i,'sample','clock'),a=m||a||s.shortName;let y=je(),k=!!t;t||(z(s)&&z(i)?t=u(d?d(ue(ke(s)),ue(ke(i))):ue(ke(s)),{name:a,sid:o}):(t=c(a),y&&he(t).seq.push(y.loader)));let b=k&&I(t)&&he(t).meta.nativeTemplate;if(z(s)){let e=ke(s);Ne(s,[lt(i,t,{scope:{fn:d,targetTemplate:b},node:[y&&y.loader,!l&&re({priority:j}),ae({store:e,to:d?E:P}),d&&oe({fn:de}),y&&k&&y.upward],meta:{op:F,sample:x}})]),y&&(Ze(y.plain,e)||Ze(y.closure,e)||y.closure.push(e))}else{let e=ce(0),r=ce(),a=ce();y&&y.plain.push(e,r,a),n({parent:s,node:[ie({store:r}),ae({from:_,store:1,target:e})],family:{owners:[s,t,i],links:t},meta:{op:F,sample:'source'},regional:1}),Ne(s,[lt(i,t,{scope:{fn:d,targetTemplate:b},node:[y&&y.loader,ie({store:a}),ae({store:e}),le({fn:e=>e}),!l&&re({priority:j}),ae({store:r}),ae({store:a,to:E}),d&&oe({fn:pe}),y&&k&&y.upward],meta:{op:F,sample:'clock'}})])}return t}function y(e){let t=Object.values(e),r={};return f(t,(({id:e})=>{r[e]=[]})),f(t,(({id:e,before:t,after:a})=>{t&&f(t,(t=>{r[t.from.id].push(e)})),a&&f(a,(t=>{r[e].push(t.to.id)}))})),r}function k(e,t=(()=>{})){if(e instanceof Map){let r={};for(let[a,n]of e)I(a)||G('Map key should be a unit'),t(a,n),r[a.sid]=n;return r}return e}function b(e,t){function r(e){l[e]=1;let t=a[e];for(let e=0;e<t.length;e++){let a=t[e];l[a]||o[a]||r(a)}l[e]=0,o[e]=1,n.push(e)}let a={};for(let t in e)a[t]=[...new Set(e[t])];let n=[],o={},l={};for(let e in a)o[e]||l[e]||r(e);if(n.reverse(),t&&t.size>0){let e,r=[],o=[...t];for(;e=o.shift();)r.push(e),f(a[e],(e=>{Ze(r,e)||Ze(o,e)||o.push(e)}));f(r,(e=>{et(n,e)}))}return n}function w(e){let t=[];return function e(r){Ze(t,r)||(t.push(r),v(r,e))}(he(e)),t}function v(e,t){let r=e.meta.unit;'fork'!==r&&r!==D&&(f(e.next,t),f(ge(e),t),f(ye(e),t))}let S='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',x='store',q='event',N='effect',A='domain',j='sampler',O='crosslink',C='map',P='stack',R='barrier',_='value',D='forkInFlightCounter',F='sample',M='filter',E='a',I=e=>(V(e)||U(e))&&'kind'in e;const $=e=>t=>I(t)&&t.kind===e;let z=$(x),T=$(q),W=$(N),H=$(A);var B={__proto__:null,unit:I,store:z,event:T,effect:W,domain:H};let G=e=>{throw Error(e)},U=e=>'object'==typeof e&&null!==e,V=e=>'function'==typeof e,J=e=>{U(e)||V(e)||G('expect first argument be an object')};const K=()=>{let e=0;return()=>(++e).toString(36)};let L=K(),Q=K(),X=K(),Y=(e,t)=>e.bind(null,t),Z=(e,t,r)=>e.bind(null,t,r);const ee=(e,t,r)=>({id:Q(),type:e,data:r,hasRef:t});let te=0,re=({priority:e=R})=>ee(R,0,{barrierID:++te,priority:e}),ae=({from:e=x,store:t,target:r,to:a=(r?x:P)})=>ee('mov',e===x,{from:e,store:t,to:a,target:r}),ne={defined:()=>ee('check',0,{type:'defined'}),changed:({store:e})=>ee('check',1,{type:'changed',store:e})},oe=Z(ee,'compute',0),le=Z(ee,M,0),se=Z(ee,'run',0),ie=({store:e})=>ae({from:P,target:e});var fe={__proto__:null,barrier:re,mov:ae,check:ne,compute:oe,filter:le,run:se,update:ie};let ce=e=>({id:Q(),current:e}),ue=({current:e})=>e,pe=(e,{fn:t},{a:r})=>t(e,r),de=(e,{fn:t},{a:r})=>t(r,e),me=(e,{fn:t})=>t(e),he=e=>e.graphite||e,ge=e=>e.family.owners,ye=e=>e.family.links,ke=e=>e.stateRef,be=e=>e.config,we=e=>e.ɔ,ve=e=>e.value,Se=e=>e.subscribers,xe=e=>e.parent,qe=e=>e.forkPage,Ne=(e,t)=>{let r=he(e);for(let e=0;e<t.length;e++){let a=he(t[e]);r.family.type!==A&&(a.family.type=O),ge(a).push(r),ye(r).push(a)}},Ae=null,je=()=>Ae&&Ae.template,Oe=e=>(e&&Ae&&Ae.sidRoot&&(e=`${Ae.sidRoot}ɔ${e}`),e);const Ce=(e=[])=>{let t=[];if(Array.isArray(e))for(let r=0;r<e.length;r++)Array.isArray(e[r])?t.push(...e[r]):t.push(e[r]);else t.push(e);return t.map(he)};let Pe=({hasRef:e,type:t,data:r},a)=>{let n;e&&(n=r.store,a[n.id]=n),'mov'===t&&r.to===x&&(n=r.target,a[n.id]=n)},Re=null;const _e=(e,t)=>{if(!e)return t;if(!t)return e;let r,a=e.v.type===t.v.type;return(a&&e.v.id>t.v.id||!a&&e.v.type===j)&&(r=e,e=t,t=r),r=_e(e.r,t),e.r=e.l,e.l=r,e},De=[];let Fe=0;for(;Fe<5;)De.push({first:null,last:null,size:0}),Fe+=1;const Me=()=>{for(let e=0;e<5;e++){let t=De[e];if(t.size>0){if(2===e||3===e){t.size-=1;let e=Re.v;return Re=_e(Re.l,Re.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Ee=(e,t,r,a,n,o)=>Ie(0,{a:null,b:null,node:r,parent:a,value:n,page:t,forkPage:o},e),Ie=(e,t,r,a=0)=>{let n=$e(r),o=De[n],l={v:{idx:e,stack:t,type:r,id:a},l:0,r:0};2===n||3===n?Re=_e(Re,l):(0===o.size?o.first=l:o.last.r=l,o.last=l),o.size+=1},$e=e=>{switch(e){case'child':return 0;case'pure':return 1;case R:return 2;case j:return 3;case N:return 4;default:return-1}},ze=new Set;let Te,We=1,He=0,Be=null,Ge=e=>{Te=e},Ue=e=>{Be=e};const Ve=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=xe(e);if(e)return e}return null},Je=(e,t,r)=>(Ve(e,r)||t).reg[r],Ke=(e,{fn:t},r)=>{try{return t(ve(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let Le=(e,t)=>''+e.shortName+t,Qe=(e,t)=>null==t?Le(e,' → *'):t,Xe=(e,t)=>{J(e),we(e)&&t(be(e),we(e))},Ye=e=>{let t;return Xe(e[0],((r,a)=>{t=r,e=a})),[e,t]},Ze=(e,t)=>e.includes(t),et=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)};const tt=(e,t)=>{et(e.next,t),et(ge(e),t),et(ye(e),t)},rt=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=ye(e);for(;a=n.pop();)tt(a,e),(t||r&&!e.meta.sample||a.family.type===O)&&rt(a,t,'on'!==a.meta.op&&r);for(n=ge(e);a=n.pop();)tt(a,e),r&&a.family.type===O&&rt(a,t,'on'!==a.meta.op&&r)},at=e=>e.clear();let nt=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),z(e))at(Se(e));else if(H(e)){r=1;let t=e.history;at(t.events),at(t.effects),at(t.stores),at(t.domains)}rt(he(e),!!t,r)},ot=e=>{let t=Z(nt,e,void 0);return t.unsubscribe=t,t},lt=(e,t,{node:r,scope:a,meta:o})=>n({node:r,parent:e,child:t,scope:a,meta:o,family:{owners:[e,t],links:t},regional:1}),st=e=>{let t;Xe(e,((r,a)=>{t=r,e=a}));let{from:a,to:o,meta:l={op:'forward'}}=e;return r(a,'forward','"from"'),r(o,'forward','"to"'),t&&(l.config=t),ot(n({parent:a,child:o,meta:l,family:{},regional:1}))},ft=(e,t)=>{if(V(t)||G('.watch argument should be a function'),Te){let t=Te.nodeMap[he(e).id];t&&(e=t)}return ot(n({scope:{fn:t},node:[se({fn:me})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))};const ct=(e,t)=>(U(e)&&(ct(be(e),t),null!=e.name&&(U(e.name)?ct(e.name,t):V(e.name)?t.handler=e.name:t.name=e.name),e.loc&&(t.loc=e.loc),(e.sid||null===e.sid)&&(t.sid=e.sid),e.handler&&(t.handler=e.handler),e.updateFilter&&(t.updateFilter=e.updateFilter),xe(e)&&(t.parent=xe(e)),'strict'in e&&(t.strict=e.strict),e.named&&(t.named=e.named),ct(we(e),t)),t);let ut,pt=(e,t,r=q)=>{xe(e)&&xe(e).hooks[r](t)},dt=(e,t,r,a)=>{let n=ct({name:a,config:r},{}),o=e===A,l=L(),{parent:i=null,sid:f=null,strict:c=1,named:u=null}=n,p=u||n.name||(o?'':l),d=s(p,i),m={unit:t.kind=e,name:t.shortName=p,sid:t.sid=Oe(f),named:u,unitId:t.id=l};if(t.parent=i,t.compositeName=d,t.defaultConfig=n,t.thru=e=>e(t),t.getType=()=>d.fullName,!o){t.subscribe=e=>(J(e),t.watch(V(e)?e:t=>{e.next&&e.next(t)})),t[S]=()=>t;let e=je();e&&(m.nativeTemplate=e)}return ut=c,m},mt=e=>c({named:e});const ht=(e,t,r,a)=>lt(e,t,{scope:{fn:a},node:[oe({fn:me})],meta:{op:r}}),gt=(e,t,r,a)=>{let n;U(r)&&(n=r,r=r.fn);let o=c(Le(e,' →? *'),n);return lt(e,o,{scope:{fn:r},node:a,meta:{op:t}}),o},yt=(e,t,r,a,n,o)=>{let l=ke(t),s=[ae({store:l,to:E}),oe({fn:a?de:pe}),ne.defined(),ne.changed({store:l}),o&&le({fn:(e,t,{a:r})=>o(e,r)}),ie({store:l})],i=je();if(i&&(s.unshift(i.loader),s.push(i.upward),z(e))){let t=ke(e);Ze(i.plain,t)||(Ze(i.closure,t)||i.closure.push(t),l.before||(l.before=[]),l.before.push({type:'closure',of:t}))}return lt(e,t,{scope:{fn:n},node:s,meta:{op:r}})},kt=e=>t=>e(...t),bt=(e,t,r,a)=>{let n=e?e=>e.slice():e=>({...e}),o=e?[]:{},s=je(),f=n(o),c=ce(f),p=ce(1);c.type=e?'list':'shape',s&&s.plain.push(c,p);let d=u(f,{name:r||l(t)});he(d).meta.isCombine=1;let m=[ne.defined(),ae({store:c,to:E}),le({fn:(e,{key:t},{a:r})=>e!==r[t]}),ae({store:p,to:'b'}),oe({fn(e,{clone:t,key:r},a){a.b&&(a.a=t(a.a)),a.a[r]=e}}),ae({from:E,target:c}),ae({from:_,store:0,target:p}),re({priority:R}),ae({from:_,store:1,target:p}),ae({store:c}),a&&oe({fn:a}),ne.changed({store:ke(d)})],h=c.before=[];return i(t,((e,t)=>{if(!z(e))return void(f[t]=o[t]=e);o[t]=e.defaultState,f[t]=e.getState();let r=lt(e,d,{scope:{key:t,clone:n},node:m,meta:{op:'combine'}}),a=ke(e);h.push({type:'field',field:t,from:a}),s&&(Ze(s.plain,a)||r.seq.unshift(s.loader))})),d.defaultShape=t,c.after=[a?{type:C,to:ke(d),fn:a}:{type:'copy',to:ke(d)}],s||(d.defaultState=a?ke(d).current=a(f):o),d};let wt=({params:e,req:t,ok:r,anyway:a,stack:n})=>l=>o({target:[a,vt],params:[r?{status:'done',params:e,result:l}:{status:'fail',params:e,error:l},{fn:r?t.rs:t.rj,value:l}],defer:1,page:n.page,forkPage:qe(n)}),vt=n({node:[se({fn({fn:e,value:t}){e(t)}})],meta:{op:'fx',fx:'sidechain'}});const St=(e,t,r)=>(e.create=t=>(o(e,t),t),he(e).seq.push(oe({fn:(e,t,r)=>(r.forkPage=null,e)})),e.watch((e=>{Ne(r,[e]),t.add(e),e.ownerSet||(e.ownerSet=t),xe(e)||(e.parent=r)})),Ne(r,[e]),r=>(t.forEach(r),e.watch(r))),xt=['source','clock','target'],qt=(e,t,r,a)=>{let n=e[t];n&&o({target:n,params:Array.isArray(n)?n.map((()=>r)):r,defer:1,stack:a})};e.allSettled=(e,{scope:t,params:r})=>{if(!I(e))return Promise.reject(Error('first argument should be unit'));let a=d();a.parentFork=Te;let{forkInFlightCounter:n}=t.graphite.scope;n.scope.defers.push(a);let l=[t.find(e)],s=[];return W(e)?s.push({params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}):s.push(r),l.push(n),s.push(null),o({target:l,params:s,forkPage:t}),a.req},e.attach=e=>{let t;Xe(e,((r,a)=>{t=r,e=a}));let{source:r,effect:a,mapParams:n}=e;n||(n=r?(e,t)=>t:e=>e);let l,s=m(e,t),{runner:i}=he(s).scope,f=({params:e,req:t},{finally:r,effect:a},l)=>{let s,i=wt({params:e,req:t,ok:0,anyway:r,stack:l});try{s=n(e,l.a)}catch(e){return i(e)}o({target:a,params:{params:s,req:{rs:wt({params:e,req:t,ok:1,anyway:r,stack:l}),rj:i}},page:l.page,defer:1})};if(r){let e;z(r)?(e=r,Ne(r,[s])):(e=p(r),Ne(s,[e]));let t=ae({from:x,store:ke(e),to:E});l=[se({fn:e=>e}),t,oe({fn:f})],Pe(t,i.reg)}else l=[se({fn:f})];return Ne(a,[s]),i.scope.effect=a,i.meta.onCopy.push(N),i.seq.splice(0,1,...l),pt(a,s,N),s},e.clearNode=nt,e.combine=p,e.createApi=(...e)=>{let[[t,r],a]=Ye(e),n={};return i(r,((e,r)=>{let o=n[r]=c(r,{parent:xe(t),config:a});t.on(o,e),pt(t,o)})),n},e.createDomain=function e(t,r){let a=new Set,o=new Set,l=new Set,s=new Set,f=n({family:{type:A},regional:1}),p={history:{domains:a,stores:o,effects:l,events:s},graphite:f};f.meta=dt(A,p,r,t);let[d,h,g,y]=['onEvent','onEffect','onStore','onDomain'].map(mt);p.hooks={event:d,effect:h,store:g,domain:y},p.onCreateEvent=St(d,s,p),p.onCreateEffect=St(h,l,p),p.onCreateStore=St(g,o,p),p.onCreateDomain=St(y,a,p),p.createEvent=p.event=(e,t)=>d(c(e,{parent:p,config:t})),p.createEffect=p.effect=(e,t)=>h(m(e,{parent:p,config:t})),p.createDomain=p.domain=(t,r)=>e({name:t,parent:p,config:r}),p.createStore=p.store=(e,t)=>g(u(e,{parent:p,config:t}));let k=xe(p);return k&&(i(p.hooks,((e,t)=>{st({from:e,to:k.hooks[t]})})),k.hooks.domain(p)),p},e.createEffect=m,e.createEvent=c,e.createNode=n,e.createStore=u,e.createStoreObject=p,e.fork=(e,{values:t,handlers:r}={})=>{H(e)||G('first argument of fork should be domain');let a=!!t;t=k(t||{},(e=>!z(e)&&G('Values map can contain only stores as keys')));let o=(e=>{function t(e){let t=he(e),a=r.indexOf(t);if(-1===a){let r='unit';e!==t&&e.id!==e.shortName&&(r=e.shortName),G(`${r} not found in forked scope`)}return p[a]}let r=w(e),a=new Map,o=new Set,l=oe({fn:(e,t,r)=>((!r.node.meta.isCombine||xe(r)&&'combine'!==xe(r).node.meta.op)&&o.add(r.node.meta.forkOf.id),e)}),s=n({scope:{defers:[],inFlight:0,fxID:0},node:[oe({fn(e,t,r){r.parent?'finally'===r.parent.node.meta.named?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1}}),re({priority:j}),se({fn(e,t){let{inFlight:r,defers:a,fxID:n}=t;r>0||0===a.length||Promise.resolve().then((()=>{t.fxID===n&&f(a.splice(0,a.length),(e=>{Ge(e.parentFork),e.rs(e.value)}))}))}})],meta:{unit:D}}),c={},u={},p=r.map((e=>{let{seq:t,next:r,meta:a,scope:o}=e,l=n({node:t.map((e=>({id:e.id,type:e.type,data:{...e.data},hasRef:e.hasRef}))),child:[...r],meta:{forkOf:e,...a},scope:{...o}});return l.family={type:e.family.type,links:[...ye(e)],owners:[...ge(e)]},c[e.id]=l,a.sid&&(u[a.sid]=l),l})),d={};return f(p,(e=>{let{reg:r,scope:n,meta:{onCopy:o,op:c,unit:u}}=e;switch(i(r,((e,t)=>{let n=a.get(e);n||(n={id:e.id,current:e.current},a.set(e,n)),d[t]=r[t]=n})),o&&f(o,(e=>{let r=n[e];n[e]=Array.isArray(r)?r.map(t):t(r)})),v(e,((e,r,a)=>{a[r]=t(e)})),c||u){case x:e.meta.wrapped=(e=>({kind:x,getState:()=>e.reg[e.scope.state.id].current,updates:{watch:Y(ft,e)},graphite:e,family:e.family}))(e),e.meta.sid&&e.seq.push(l);break;case N:e.next.push(s);break;case'fx':n.finally.next.push(s)}})),{cloneOf:e,changedStores:o,nodeMap:c,sidMap:u,clones:p,find:t,reg:d,getState:e=>t(e).meta.wrapped.getState(),graphite:n({family:{type:A,links:[s,...p]},meta:{unit:'fork'},scope:{forkInFlightCounter:s}})}})(e);if(a&&(()=>{let r=w(e),a={},n={},l=new Set,s=new Set,c=Object.getOwnPropertyNames(t);f(r,(({reg:e,meta:t})=>{let{nativeTemplate:r}=t;i(e,((e,t)=>{a[t]=e,r&&s.add(t)}))})),f(o.clones,(e=>{let{reg:r}=e,{unit:a,sid:s}=e.meta;if(a===x&&s&&Ze(c,s)){let{state:a}=e.scope;r[a.id].current=t[s],l.add(a),o.changedStores.add(e.meta.forkOf.id)}i(r,((e,t)=>{n[t]=e}))})),f(b(y(a),s),(e=>{((e,t)=>{let r=0;if(t&&t.before&&!l.has(e)&&f(t.before,(t=>{switch(t.type){case C:e.current=t.fn(n[t.from.id].current);break;case'field':{let a=n[t.from.id];r||(r=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[t.field]=a.current;break}}})),!t||!t.after)return;let a=e.current;f(t.after,(e=>{let t=n[e.to.id];switch(e.type){case'copy':t.current=a;break;case C:t.current=e.fn(a)}}))})(n[e],a[e])}))})(),r){r=k(r,(e=>!W(e)&&G("Handlers map can contain only effects as keys")));let e=Object.keys(r);f(o.clones,(({scope:t,meta:a})=>{a.sid&&Ze(e,a.sid)&&(t.runner.scope.getHandler=()=>r[a.sid])}))}return o},e.forward=st,e.fromObservable=e=>{J(e);let t=S in e?e[S]():e;t.subscribe||G('expect observable to have .subscribe');let r=c(),a=Z(nt,r,void 0);return t.subscribe({next:r,error:a,complete:a}),r},e.guard=(...e)=>{let t={op:'guard'},a='guard',[[o,l],s]=Ye(e);s&&(t.config=s,s.name&&(a=s.name)),l||(l=o,o=l.source);let{filter:i,greedy:f,clock:u,name:d=a}=l,m=l.target||c(d,t.config),y=I(i),k=1;return void 0===o&&(r(u,'guard','clock'),Array.isArray(u)&&(u=h(u)),o=u,k=0),k&&!I(o)&&(o=p(o)),u&&(r(u,'guard','clock'),o=g({source:o,clock:u,greedy:f,fn:y?null:(e,t)=>({source:e,clock:t})})),r(m,'guard','target'),y?g({source:i,clock:o,target:n({node:[le({fn:({guard:e})=>e}),oe({fn:({data:e})=>e})],child:m,meta:t,family:{owners:[o,i,m,...[].concat(u||[])],links:m},regional:1}),fn:(e,t)=>({guard:e,data:t}),greedy:f,name:d}):(V(i)||G('`filter` should be function or unit'),lt(o,m,{scope:{fn:i},node:u?[le({fn:({source:e,clock:t},{fn:r})=>r(e,t)}),oe({fn:({source:e})=>e})]:[le({fn:me})],meta:t})),m},e.hydrate=(e,{values:t})=>{let r=U(e)&&e.cloneOf;H(e)||r||G('first argument of hydrate should be domain or scope'),U(t)||G('values property should be an object');let a,n,l=k(t);if(r)a=[],n=[],i(l,((t,r)=>{let o=e.sidMap[r];o&&(a.push(o),n.push(t),e.changedStores.add(o.meta.forkOf.id))}));else{let t=(({flatGraphUnits:e,values:t,collectWatches:r})=>{let a=[],n=[],o={},l=new Set,s=Object.getOwnPropertyNames(t);return f(e,(e=>{let{reg:f}=e,{op:c,unit:u,sid:p}=e.meta;if(u===x&&p&&Ze(s,p)){let{state:r}=e.scope;r.current=t[p],l.add(r)}if(r&&'watch'===c){let t=e.family.owners[0];t.meta.unit===x&&(a.push(e),n.push(t.scope.state))}i(f,((e,t)=>{o[t]=e}))})),f(b(y(o)),(e=>{(e=>{let t=0;if(e.before&&!l.has(e)&&f(e.before,(r=>{switch(r.type){case C:e.current=r.fn(r.from.current);break;case'field':{let a=r.from;t||(t=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[r.field]=a.current;break}}})),!e.after)return;let r=e.current;f(e.after,(e=>{let t=e.to;switch(e.type){case'copy':t.current=r;break;case C:t.current=e.fn(r)}}))})(o[e])})),{storeWatches:a,storeWatchesRefs:n}})({flatGraphUnits:w(e),values:l,collectWatches:1});a=t.storeWatches,n=t.storeWatchesRefs.map((({current:e})=>e))}o({target:a,params:n,forkPage:r?e:0})},e.is=B,e.launch=o,e.merge=h,e.restore=(e,t,r)=>{if(z(e))return e;if(I(e)){let a,n=xe(e);return T(e)&&(a=u(t,{parent:n,name:e.shortName,ɔ:r}).on(e,((e,t)=>t))),W(e)&&(a=u(t,{parent:n,name:e.shortName,ɔ:r}).on(e.done,((e,{result:t})=>t))),n&&n.hooks.store(a),a}let a=Array.isArray(e)?[]:{};return i(e,((e,t)=>{a[t]=z(e)?e:u(e,{name:t})})),a},e.sample=g,e.scopeBind=e=>{Te||G('scopeBind cannot be called outside of forked .watch');let t=Te,r=Te.find(e);return W(e)?e=>{let a=d();o({target:r,params:{params:e,req:a},forkPage:t})}:e=>(o({target:r,params:e,forkPage:t}),e)},e.serialize=({clones:e,changedStores:t},{ignore:r=[],onlyChanges:a}={})=>{let n={};return f(e,(({meta:e,scope:r,reg:o})=>{if(e.unit!==x)return;let{sid:l}=e;l&&(!a&&!e.isCombine||t.has(e.forkOf.id))&&(n[l]=o[r.state.id].current)})),f(r,(({sid:e})=>{e&&delete n[e]})),n},e.setStoreName=(e,t)=>{let r=s(t,xe(e));if(e.shortName=t,!e.compositeName)return void(e.compositeName=r);let a=e.compositeName;a.path=r.path,a.shortName=r.shortName,a.fullName=r.fullName},e.split=(...e)=>{let t,[[r,a],o]=Ye(e),l=!a;l&&(t=r.cases,a=r.match,r=r.source);let s=z(a),f=!I(a)&&V(a),u=!s&&!f&&U(a);t||(t={}),l||(u||G('match should be an object'),i(a,((e,r)=>{t[r]=c(o)})),t.__=c(o));let p,d=je(),m=new Set([].concat(r,Object.values(t))),h=Object.keys(s||f?t:a);if(s||f)s&&m.add(a),p=[s&&re({priority:'sampler'}),s&&ae({store:ke(a),to:'a'}),le({fn(e,t,r){let n=String(s?r.a:a(e));qt(t,Ze(h,n)?n:'__',e,r)}})];else if(u){let e=ce({});e.type='shape';let t,r=e.before=[],n=[ae({store:e,to:E}),oe({fn(e,{key:t},{a:r}){r[t]=e}})],o=[];i(a,((a,l)=>{if(I(a)){t=1,o.push(l),m.add(a);let s=lt(a,[],{node:n,scope:{key:l}});if(z(a)){e.current[l]=a.getState();let t=ke(a);r.push({type:'field',field:l,from:t}),d&&(Ze(d.plain,t)||s.seq.unshift(d.loader))}}})),t&&d&&d.plain.push(e),p=[t&&re({priority:'sampler'}),t&&ae({store:e,to:'a'}),le({fn(e,t,r){for(let n=0;n<h.length;n++){let l=h[n];if(Ze(o,l)?r.a[l]:a[l](e))return void qt(t,l,e,r)}qt(t,'__',e,r)}})]}else G('expect match to be unit, function or object');if(n({meta:{onCopy:Object.keys(t),op:'split'},parent:r,scope:t,node:p,family:{type:'crosslink',owners:Array.from(m)},regional:1}),!l)return t},e.step=fe,e.version="21.8.12",e.withFactory=({sid:e,name:t,loc:r,method:o,fn:l})=>a(n({meta:{sidRoot:Oe(e),name:t,loc:r,method:o}}),l),e.withRegion=a,Object.defineProperty(e,'__esModule',{value:1})}));
//# sourceMappingURL=effector.umd.js.map
