function e(e,t,r,a){(R(e)||_(e))&&('family'in e||'graphite'in e)||F(`${t}: expect ${r} to be a unit (store, event or effect)${a}`)}function t(t,r,a){if(Array.isArray(t))for(let n=0;n<t.length;n++)e(t[n],r,`${n} item of ${a}`,'');else e(t,r,a,' or array of units')}function r(e,t){let r=re(e).meta;de={parent:de,value:e,template:r.template||me(),sidRoot:r.sidRoot||de&&de.sidRoot};try{return t()}finally{de=ce(de)}}function a({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:o,child:s=n||o,scope:l={},meta:i={},family:f={type:'regular'},regional:c}={}){let u=ge(a),p=ge(f.links),d=ge(f.owners),m=[],h={};for(let t=0;t<e.length;t++){let r=e[t];r&&(m.push(r),ye(r,h))}let g={id:$(),seq:m,next:ge(s),meta:i,scope:l,family:{type:f.type||"crosslink",links:p,owners:d},reg:h};for(let e=0;e<p.length;e++)ae(p[e]).push(g);for(let e=0;e<d.length;e++)ne(d[e]).push(g);for(let e=0;e<u.length;e++)u[e].next.push(g);return c&&de&&pe(ie(de),[g]),g}function n(e,t,r){let a=Pe,n=null,o=je;if(e.target&&(t=e.params,r=e.defer,a='page'in e?e.page:a,e.stack&&(n=e.stack),o=ue(e)||o,e=e.target),o&&je&&o!==je&&(je=null),Array.isArray(e))for(let r=0;r<e.length;r++)Se('pure',a,re(e[r]),n,t[r],o);else Se('pure',a,re(e),n,t,o);if(r&&!Ce)return;let s,l,i,f,c,u,p={isRoot:Ce,currentPage:Pe,forkPage:je,isWatch:Oe};Ce=0;e:for(;f=xe();){let{idx:e,stack:t,type:r}=f;i=t.node,Pe=c=t.page,je=ue(t),u=(c||i).reg;let a={fail:0,scope:i.scope};s=l=0;for(let n=e;n<i.seq.length&&!s;n++){let o=i.seq[n],f=o.data;switch(o.type){case"barrier":{let a=f.barrierID;c&&(a=`${c.fullID}_${a}`);let o=f.priority;if(n!==e||r!==o){Ae.has(a)||(Ae.add(a),qe(n,t,o,a));continue e}Ae.delete(a);break}case'mov':{let e;switch(f.from){case"stack":e=ie(t);break;case"a":case'b':e=t[f.from];break;case"value":e=f.store;break;case x:u[f.store.id]||(t.page=c=_e(c,f.store.id),u=c?c.reg:i.reg),e=Y(u[f.store.id])}switch(f.to){case"stack":t.value=e;break;case"a":case'b':t[f.to]=e;break;case x:De(c,i,f.target.id).current=e}break}case'check':switch(f.type){case'defined':l=void 0===ie(t);break;case'changed':l=ie(t)===Y(De(c,i,f.store.id))}break;case"filter":l=!Me(a,f,t);break;case'run':if(n!==e||"effect"!==r){qe(n,t,"effect");continue e}case'compute':Oe='watch'===i.meta.op,t.value=Me(a,f,t),Oe=p.isWatch}s=a.fail||l}if(!s)for(let e=0;e<i.next.length;e++)Se('child',c,i.next[e],t,ie(t),ue(t))}Ce=p.isRoot,Pe=p.currentPage,je=ue(p)}function o(e,t="combine"){let r=t+'(',a='',n=0;for(let t in e){let o=e[t];if(null!=o&&(r+=a,r+=q(o)?o.compositeName.fullName:o.toString()),n+=1,25===n)break;a=', '}return r+=')',r}function s(e,t){let r,a,n,o=e;return t?(n=t.compositeName,0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)):(r=0===e.length?[]:[e],a=e),{shortName:o,fullName:a,path:r}}function l(e,t){for(let r in e)t(e[r],r)}function i(e,t){e.forEach(t)}function f(e,t){let r=(e,...t)=>Pe?((e,t,r,a)=>{let n=Pe,o=null;if(t)for(o=Pe;o&&o.template!==t;)o=ce(o);Re(o);let s=e.create(r,a);return Re(n),s})(r,o,e,t):r.create(e,t);r.graphite=a({meta:Ze("event",r,t,e),regional:1}),r.create=e=>(n(je?je.find(r):r,e),e),r.watch=z(Le,r),r.map=e=>{let t,a;R(e)&&(t=e,a=e.name,e=e.fn);let n=f(Ee(r,a),t);return tt(r,n,S,e),n},r.filter=e=>rt(r,"filter",e.fn?e:e.fn,[J({fn:te})]),r.filterMap=e=>rt(r,'filterMap',e,[V({fn:te}),U.defined()]),r.prepend=e=>{let t=f('* → '+r.shortName,{parent:ce(r)}),a=me();return a&&re(t).seq.push(a.upward),tt(t,r,'prepend',e),Ye(r,t),t};let o=me();return r}function c(e,r){function o(e,t){p.off(e),fe(p).set(e,Ve(at(e,p,'on',1,t,m)))}let s=X(e),l=X(e),i=et('updates'),f=me();s.after=[{type:'copy',to:l}],f&&f.plain.push(s,l);let u=s.id,p={subscribers:new Map,updates:i,defaultState:e,stateRef:s,getState(){let e,t=s;if(Pe){let t=Pe;for(;t&&!t.reg[u];)t=ce(t);t&&(e=t)}return!e&&je&&je.reg[u]&&(e=je),e&&(t=e.reg[u]),Y(t)},setState(e){let t;je&&(t=je.nodeMap[re(p).id]),t||(t=p),n({target:t,params:e,defer:1})},reset(...e){for(let t of e)p.on(t,(()=>p.defaultState));return p},on(e,r){if(t(e,'.on','first argument'),Array.isArray(e))for(let t of e)o(t,r);else o(e,r);return p},off(e){let t=fe(p).get(e);return t&&(t(),fe(p).delete(e)),p},map(e,t){let r,a,n;R(e)&&(r=e,a=e.name,t=e.firstState,e=e.fn);let o=p.getState(),l=me();l?n=null:void 0!==o&&(n=e(o,t));let i=c(n,{name:Ee(p,a),config:r,strict:0}),f=at(p,i,S,0,e);return oe(i).before=[{type:S,fn:e,from:s}],l&&(We(l.plain,s)||We(f.seq,l.loader)||f.seq.unshift(l.loader)),i},watch(e,t){if(!t||!q(e)){let t=Le(p,e),r=me();return r?r.watch.push({of:s,fn:e}):e(p.getState()),t}return _(t)||F('second argument should be a function'),e.watch((e=>t(p.getState(),e)))}},d=Ze(x,p,r),m=p.defaultConfig.updateFilter;return p.graphite=a({scope:{state:s},node:[U.defined(),U.changed({store:l}),m&&G({store:l,to:"a"}),m&&J({fn:(e,t,{a:r})=>m(e,r)}),L({store:s}),L({store:l})],child:i,meta:d,regional:1}),Xe&&void 0===e&&F("current state can't be undefined, use null instead"),pe(p,[i]),p}function u(...e){let t,r,a;$e(e[0],((t,r)=>{a=t,e=r}));let n,o,s=e[e.length-1];if(_(s)?(r=e.slice(0,-1),t=s):r=e,1===r.length){let e=r[0];A(e)||(n=e,o=1)}return o||(n=r,t&&(t=nt(t))),R(n)||F('shape should be an object'),ot(Array.isArray(n),n,a,t)}function p(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function d(e,t){let r=f(e,t),o=r.defaultConfig.handler||(()=>F(`no handler used in ${r.getType()}`)),s=re(r);s.meta.onCopy=['runner'],s.meta.unit=r.kind="effect",r.use=e=>(_(e)||F('.use argument should be a function'),o=e,r);let l=r.finally=et('finally'),i=r.done=l.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),u=r.fail=l.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),d=r.doneData=i.map({named:'doneData',fn:({result:e})=>e}),m=r.failData=u.map({named:'failData',fn:({error:e})=>e}),h=a({scope:{getHandler:r.use.getCurrent=()=>o,finally:l},node:[K({fn({params:e,req:t},{finally:r,getHandler:a},n){let o,s=st({params:e,req:t,ok:1,anyway:r,stack:n}),l=st({params:e,req:t,ok:0,anyway:r,stack:n});try{o=a()(e)}catch(e){return void l(e)}R(o)&&_(o.then)?o.then(s,l):s(o)}})],meta:{op:'fx',fx:'runner',onCopy:['finally']}});s.scope.runner=h,s.seq.push(V({fn:(e,t,r)=>ce(r)?{params:e,req:{rs(e){},rj(e){}}}:e}),K({fn:(e,{runner:t},r)=>(n({target:t,params:e,defer:1,forkPage:ue(r)}),e.params)})),r.create=e=>{let t=p(),a={params:e,req:t};if(je){if(!Oe){let e=je;t.req.finally((()=>{Fe(e)})).catch((()=>{}))}n(je.find(r),a)}else n(r,a);return t.req};let g=r.inFlight=c(0,{named:'inFlight'}).on(r,(e=>e+1)).on(l,(e=>e-1)),y=r.pending=g.map({fn:e=>e>0,named:'pending'});return pe(r,[l,i,u,d,m,y,g,h]),r}function m(e,r){let a=f(r||o(e,'merge'));return t(e,'merge','first argument'),Ke({from:e,to:a,meta:{op:'merge'}}),a}function h(...e){let r,n,o,s,[[l,p,d],h]=ze(e);void 0===p&&R(l)&&(e=>{let t=0;return i(ct,(r=>{r in e&&(null==e[r]&&F(`sample: ${r} should be defined`),t=1)})),t})(l)&&(p=l.clock,d=l.fn,s=l.greedy,r=l.target,n=l.name,o=l.sid,l=l.source);let g=1;void 0===l&&(t(p,'sample','clock'),Array.isArray(p)&&(p=m(p)),l=p,g=0),g&&!q(l)&&(l=u(l)),void 0===p&&(p=l),t(p,'sample','clock'),n=h||n||l.shortName;let y=me(),k=!!r;r||(A(l)&&A(p)?r=c(d?d(Y(oe(l)),Y(oe(p))):Y(oe(l)),{name:n,sid:o}):(r=f(n),y&&re(r).seq.push(y.loader)));let b=k&&q(r)&&re(r).meta.nativeTemplate;if(A(l)){let e=oe(l);pe(l,[Je(p,r,{scope:{fn:d,targetTemplate:b},node:[y&&y.loader,!s&&B({priority:"sampler"}),G({store:e,to:d?"a":"stack"}),d&&V({fn:ee}),y&&k&&y.upward],meta:{op:"sample",sample:x}})]),y&&(We(y.plain,e)||We(y.closure,e)||y.closure.push(e))}else{let e=X(0),t=X(),n=X();y&&y.plain.push(e,t,n),a({parent:l,node:[L({store:t}),G({from:"value",store:1,target:e})],family:{owners:[l,r,p],links:r},meta:{op:"sample",sample:'source'},regional:1}),pe(l,[Je(p,r,{scope:{fn:d,targetTemplate:b},node:[y&&y.loader,L({store:n}),G({store:e}),J({fn:e=>e}),!s&&B({priority:"sampler"}),G({store:t}),G({store:n,to:"a"}),d&&V({fn:Z}),y&&k&&y.upward],meta:{op:"sample",sample:'clock'}})])}return r}function g(e){let t=Object.values(e),r={};return i(t,(({id:e})=>{r[e]=[]})),i(t,(({id:e,before:t,after:a})=>{t&&i(t,(t=>{r[t.from.id].push(e)})),a&&i(a,(t=>{r[e].push(t.to.id)}))})),r}function y(e,t=(()=>{})){if(e instanceof Map){let r={};for(let[a,n]of e)q(a)||F('Map key should be a unit'),t(a,n),r[a.sid]=n;return r}return e}function k(e,t){function r(e){s[e]=1;let t=a[e];for(let e=0;e<t.length;e++){let a=t[e];s[a]||o[a]||r(a)}s[e]=0,o[e]=1,n.push(e)}let a={};for(let t in e)a[t]=[...new Set(e[t])];let n=[],o={},s={};for(let e in a)o[e]||s[e]||r(e);if(n.reverse(),t&&t.size>0){let e,r=[],o=[...t];for(;e=o.shift();)r.push(e),i(a[e],(e=>{We(r,e)||We(o,e)||o.push(e)}));i(r,(e=>{Te(n,e)}))}return n}function b(e){let t=[];return function e(r){We(t,r)||(t.push(r),v(r,e))}(re(e)),t}function v(e,t){let r=e.meta.unit;'fork'!==r&&"forkInFlightCounter"!==r&&(i(e.next,t),i(ae(e),t),i(ne(e),t))}Object.defineProperty(exports,'__esModule',{value:1});let w='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',x='store',S='map',q=e=>(_(e)||R(e))&&'kind'in e;const N=e=>t=>q(t)&&t.kind===e;let A=N(x),j=N("event"),C=N("effect"),O=N("domain");var P={__proto__:null,unit:q,store:A,event:j,effect:C,domain:O};let F=e=>{throw Error(e)},R=e=>'object'==typeof e&&null!==e,_=e=>'function'==typeof e,D=e=>{R(e)||_(e)||F('expect first argument be an object')};const M=()=>{let e=0;return()=>(++e).toString(36)};let I=M(),E=M(),$=M(),z=(e,t)=>e.bind(null,t),W=(e,t,r)=>e.bind(null,t,r);const T=(e,t,r)=>({id:E(),type:e,data:r,hasRef:t});let H=0,B=({priority:e="barrier"})=>T("barrier",0,{barrierID:++H,priority:e}),G=({from:e=x,store:t,target:r,to:a=(r?x:"stack")})=>T('mov',e===x,{from:e,store:t,to:a,target:r}),U={defined:()=>T('check',0,{type:'defined'}),changed:({store:e})=>T('check',1,{type:'changed',store:e})},V=W(T,'compute',0),J=W(T,"filter",0),K=W(T,'run',0),L=({store:e})=>G({from:"stack",target:e});var Q={__proto__:null,barrier:B,mov:G,check:U,compute:V,filter:J,run:K,update:L};let X=e=>({id:E(),current:e}),Y=({current:e})=>e,Z=(e,{fn:t},{a:r})=>t(e,r),ee=(e,{fn:t},{a:r})=>t(r,e),te=(e,{fn:t})=>t(e),re=e=>e.graphite||e,ae=e=>e.family.owners,ne=e=>e.family.links,oe=e=>e.stateRef,se=e=>e.config,le=e=>e.ɔ,ie=e=>e.value,fe=e=>e.subscribers,ce=e=>e.parent,ue=e=>e.forkPage,pe=(e,t)=>{let r=re(e);for(let e=0;e<t.length;e++){let a=re(t[e]);"domain"!==r.family.type&&(a.family.type="crosslink"),ae(a).push(r),ne(r).push(a)}},de=null,me=()=>de&&de.template,he=e=>(e&&de&&de.sidRoot&&(e=`${de.sidRoot}ɔ${e}`),e);const ge=(e=[])=>{let t=[];if(Array.isArray(e))for(let r=0;r<e.length;r++)Array.isArray(e[r])?t.push(...e[r]):t.push(e[r]);else t.push(e);return t.map(re)};let ye=({hasRef:e,type:t,data:r},a)=>{let n;e&&(n=r.store,a[n.id]=n),'mov'===t&&r.to===x&&(n=r.target,a[n.id]=n)},ke=null;const be=(e,t)=>{if(!e)return t;if(!t)return e;let r,a=e.v.type===t.v.type;return(a&&e.v.id>t.v.id||!a&&"sampler"===e.v.type)&&(r=e,e=t,t=r),r=be(e.r,t),e.r=e.l,e.l=r,e},ve=[];let we=0;for(;we<5;)ve.push({first:null,last:null,size:0}),we+=1;const xe=()=>{for(let e=0;e<5;e++){let t=ve[e];if(t.size>0){if(2===e||3===e){t.size-=1;let e=ke.v;return ke=be(ke.l,ke.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Se=(e,t,r,a,n,o)=>qe(0,{a:null,b:null,node:r,parent:a,value:n,page:t,forkPage:o},e),qe=(e,t,r,a=0)=>{let n=Ne(r),o=ve[n],s={v:{idx:e,stack:t,type:r,id:a},l:0,r:0};2===n||3===n?ke=be(ke,s):(0===o.size?o.first=s:o.last.r=s,o.last=s),o.size+=1},Ne=e=>{switch(e){case'child':return 0;case'pure':return 1;case"barrier":return 2;case"sampler":return 3;case"effect":return 4;default:return-1}},Ae=new Set;let je,Ce=1,Oe=0,Pe=null,Fe=e=>{je=e},Re=e=>{Pe=e};const _e=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=ce(e);if(e)return e}return null},De=(e,t,r)=>(_e(e,r)||t).reg[r],Me=(e,{fn:t},r)=>{try{return t(ie(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let Ie=(e,t)=>''+e.shortName+t,Ee=(e,t)=>null==t?Ie(e,' → *'):t,$e=(e,t)=>{D(e),le(e)&&t(se(e),le(e))},ze=e=>{let t;return $e(e[0],((r,a)=>{t=r,e=a})),[e,t]},We=(e,t)=>e.includes(t),Te=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)};const He=(e,t)=>{Te(e.next,t),Te(ae(e),t),Te(ne(e),t)},Be=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=ne(e);for(;a=n.pop();)He(a,e),(t||r&&!e.meta.sample||"crosslink"===a.family.type)&&Be(a,t,'on'!==a.meta.op&&r);for(n=ae(e);a=n.pop();)He(a,e),r&&"crosslink"===a.family.type&&Be(a,t,'on'!==a.meta.op&&r)},Ge=e=>e.clear();let Ue=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),A(e))Ge(fe(e));else if(O(e)){r=1;let t=e.history;Ge(t.events),Ge(t.effects),Ge(t.stores),Ge(t.domains)}Be(re(e),!!t,r)},Ve=e=>{let t=W(Ue,e,void 0);return t.unsubscribe=t,t},Je=(e,t,{node:r,scope:n,meta:o})=>a({node:r,parent:e,child:t,scope:n,meta:o,family:{owners:[e,t],links:t},regional:1}),Ke=e=>{let r;$e(e,((t,a)=>{r=t,e=a}));let{from:n,to:o,meta:s={op:'forward'}}=e;return t(n,'forward','"from"'),t(o,'forward','"to"'),r&&(s.config=r),Ve(a({parent:n,child:o,meta:s,family:{},regional:1}))},Le=(e,t)=>{if(_(t)||F('.watch argument should be a function'),je){let t=je.nodeMap[re(e).id];t&&(e=t)}return Ve(a({scope:{fn:t},node:[K({fn:te})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))};const Qe=(e,t)=>(R(e)&&(Qe(se(e),t),null!=e.name&&(R(e.name)?Qe(e.name,t):_(e.name)?t.handler=e.name:t.name=e.name),e.loc&&(t.loc=e.loc),(e.sid||null===e.sid)&&(t.sid=e.sid),e.handler&&(t.handler=e.handler),e.updateFilter&&(t.updateFilter=e.updateFilter),ce(e)&&(t.parent=ce(e)),'strict'in e&&(t.strict=e.strict),e.named&&(t.named=e.named),Qe(le(e),t)),t);let Xe,Ye=(e,t,r="event")=>{ce(e)&&ce(e).hooks[r](t)},Ze=(e,t,r,a)=>{let n=Qe({name:a,config:r},{}),o="domain"===e,l=I(),{parent:i=null,sid:f=null,strict:c=1,named:u=null}=n,p=u||n.name||(o?'':l),d=s(p,i),m={unit:t.kind=e,name:t.shortName=p,sid:t.sid=he(f),named:u,unitId:t.id=l};if(t.parent=i,t.compositeName=d,t.defaultConfig=n,t.thru=e=>e(t),t.getType=()=>d.fullName,!o){t.subscribe=e=>(D(e),t.watch(_(e)?e:t=>{e.next&&e.next(t)})),t[w]=()=>t;let e=me();e&&(m.nativeTemplate=e)}return Xe=c,m},et=e=>f({named:e});const tt=(e,t,r,a)=>Je(e,t,{scope:{fn:a},node:[V({fn:te})],meta:{op:r}}),rt=(e,t,r,a)=>{let n;R(r)&&(n=r,r=r.fn);let o=f(Ie(e,' →? *'),n);return Je(e,o,{scope:{fn:r},node:a,meta:{op:t}}),o},at=(e,t,r,a,n,o)=>{let s=oe(t),l=[G({store:s,to:"a"}),V({fn:a?ee:Z}),U.defined(),U.changed({store:s}),o&&J({fn:(e,t,{a:r})=>o(e,r)}),L({store:s})],i=me();if(i&&(l.unshift(i.loader),l.push(i.upward),A(e))){let t=oe(e);We(i.plain,t)||(We(i.closure,t)||i.closure.push(t),s.before||(s.before=[]),s.before.push({type:'closure',of:t}))}return Je(e,t,{scope:{fn:n},node:l,meta:{op:r}})},nt=e=>t=>e(...t),ot=(e,t,r,a)=>{let n=e?e=>e.slice():e=>({...e}),s=e?[]:{},i=me(),f=n(s),u=X(f),p=X(1);u.type=e?'list':'shape',i&&i.plain.push(u,p);let d=c(f,{name:r||o(t)});re(d).meta.isCombine=1;let m=[U.defined(),G({store:u,to:"a"}),J({fn:(e,{key:t},{a:r})=>e!==r[t]}),G({store:p,to:'b'}),V({fn(e,{clone:t,key:r},a){a.b&&(a.a=t(a.a)),a.a[r]=e}}),G({from:"a",target:u}),G({from:"value",store:0,target:p}),B({priority:"barrier"}),G({from:"value",store:1,target:p}),G({store:u}),a&&V({fn:a}),U.changed({store:oe(d)})],h=u.before=[];return l(t,((e,t)=>{if(!A(e))return void(f[t]=s[t]=e);s[t]=e.defaultState,f[t]=e.getState();let r=Je(e,d,{scope:{key:t,clone:n},node:m,meta:{op:'combine'}}),a=oe(e);h.push({type:'field',field:t,from:a}),i&&(We(i.plain,a)||r.seq.unshift(i.loader))})),d.defaultShape=t,u.after=[a?{type:S,to:oe(d),fn:a}:{type:'copy',to:oe(d)}],i||(d.defaultState=a?oe(d).current=a(f):s),d};let st=({params:e,req:t,ok:r,anyway:a,stack:o})=>s=>n({target:[a,lt],params:[r?{status:'done',params:e,result:s}:{status:'fail',params:e,error:s},{fn:r?t.rs:t.rj,value:s}],defer:1,page:o.page,forkPage:ue(o)}),lt=a({node:[K({fn({fn:e,value:t}){e(t)}})],meta:{op:'fx',fx:'sidechain'}});const ft=(e,t,r)=>(e.create=t=>(n(e,t),t),re(e).seq.push(V({fn:(e,t,r)=>(r.forkPage=null,e)})),e.watch((e=>{pe(r,[e]),t.add(e),e.ownerSet||(e.ownerSet=t),ce(e)||(e.parent=r)})),pe(r,[e]),r=>(t.forEach(r),e.watch(r))),ct=['source','clock','target'],ut=(e,t,r,a)=>{let o=e[t];o&&n({target:o,params:Array.isArray(o)?o.map((()=>r)):r,defer:1,stack:a})};exports.allSettled=(e,{scope:t,params:r})=>{if(!q(e))return Promise.reject(Error('first argument should be unit'));let a=p();a.parentFork=je;let{forkInFlightCounter:o}=t.graphite.scope;o.scope.defers.push(a);let s=[t.find(e)],l=[];return C(e)?l.push({params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}):l.push(r),s.push(o),l.push(null),n({target:s,params:l,forkPage:t}),a.req},exports.attach=e=>{let t;$e(e,((r,a)=>{t=r,e=a}));let{source:r,effect:a,mapParams:o}=e;o||(o=r?(e,t)=>t:e=>e);let s,l=d(e,t),{runner:i}=re(l).scope,f=({params:e,req:t},{finally:r,effect:a},s)=>{let l,i=st({params:e,req:t,ok:0,anyway:r,stack:s});try{l=o(e,s.a)}catch(e){return i(e)}n({target:a,params:{params:l,req:{rs:st({params:e,req:t,ok:1,anyway:r,stack:s}),rj:i}},page:s.page,defer:1})};if(r){let e;A(r)?(e=r,pe(r,[l])):(e=u(r),pe(l,[e]));let t=G({from:x,store:oe(e),to:"a"});s=[K({fn:e=>e}),t,V({fn:f})],ye(t,i.reg)}else s=[K({fn:f})];return pe(a,[l]),i.scope.effect=a,i.meta.onCopy.push("effect"),i.seq.splice(0,1,...s),Ye(a,l,"effect"),l},exports.clearNode=Ue,exports.combine=u,exports.createApi=(...e)=>{let[[t,r],a]=ze(e),n={};return l(r,((e,r)=>{let o=n[r]=f(r,{parent:ce(t),config:a});t.on(o,e),Ye(t,o)})),n},exports.createDomain=function e(t,r){let n=new Set,o=new Set,s=new Set,i=new Set,u=a({family:{type:"domain"},regional:1}),p={history:{domains:n,stores:o,effects:s,events:i},graphite:u};u.meta=Ze("domain",p,r,t);let[m,h,g,y]=['onEvent','onEffect','onStore','onDomain'].map(et);p.hooks={event:m,effect:h,store:g,domain:y},p.onCreateEvent=ft(m,i,p),p.onCreateEffect=ft(h,s,p),p.onCreateStore=ft(g,o,p),p.onCreateDomain=ft(y,n,p),p.createEvent=p.event=(e,t)=>m(f(e,{parent:p,config:t})),p.createEffect=p.effect=(e,t)=>h(d(e,{parent:p,config:t})),p.createDomain=p.domain=(t,r)=>e({name:t,parent:p,config:r}),p.createStore=p.store=(e,t)=>g(c(e,{parent:p,config:t}));let k=ce(p);return k&&(l(p.hooks,((e,t)=>{Ke({from:e,to:k.hooks[t]})})),k.hooks.domain(p)),p},exports.createEffect=d,exports.createEvent=f,exports.createNode=a,exports.createStore=c,exports.createStoreObject=u,exports.fork=(e,{values:t,handlers:r}={})=>{O(e)||F('first argument of fork should be domain');let n=!!t;t=y(t||{},(e=>!A(e)&&F('Values map can contain only stores as keys')));let o=(e=>{function t(e){let t=re(e),a=r.indexOf(t);if(-1===a){let r='unit';e!==t&&e.id!==e.shortName&&(r=e.shortName),F(`${r} not found in forked scope`)}return p[a]}let r=b(e),n=new Map,o=new Set,s=V({fn:(e,t,r)=>((!r.node.meta.isCombine||ce(r)&&'combine'!==ce(r).node.meta.op)&&o.add(r.node.meta.forkOf.id),e)}),f=a({scope:{defers:[],inFlight:0,fxID:0},node:[V({fn(e,t,r){r.parent?'finally'===r.parent.node.meta.named?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1}}),B({priority:"sampler"}),K({fn(e,t){let{inFlight:r,defers:a,fxID:n}=t;r>0||0===a.length||Promise.resolve().then((()=>{t.fxID===n&&i(a.splice(0,a.length),(e=>{Fe(e.parentFork),e.rs(e.value)}))}))}})],meta:{unit:"forkInFlightCounter"}}),c={},u={},p=r.map((e=>{let{seq:t,next:r,meta:n,scope:o}=e,s=a({node:t.map((e=>({id:e.id,type:e.type,data:{...e.data},hasRef:e.hasRef}))),child:[...r],meta:{forkOf:e,...n},scope:{...o}});return s.family={type:e.family.type,links:[...ne(e)],owners:[...ae(e)]},c[e.id]=s,n.sid&&(u[n.sid]=s),s})),d={};return i(p,(e=>{let{reg:r,scope:a,meta:{onCopy:o,op:c,unit:u}}=e;switch(l(r,((e,t)=>{let a=n.get(e);a||(a={id:e.id,current:e.current},n.set(e,a)),d[t]=r[t]=a})),o&&i(o,(e=>{let r=a[e];a[e]=Array.isArray(r)?r.map(t):t(r)})),v(e,((e,r,a)=>{a[r]=t(e)})),c||u){case x:e.meta.wrapped=(e=>({kind:x,getState:()=>e.reg[e.scope.state.id].current,updates:{watch:z(Le,e)},graphite:e,family:e.family}))(e),e.meta.sid&&e.seq.push(s);break;case"effect":e.next.push(f);break;case'fx':a.finally.next.push(f)}})),{cloneOf:e,changedStores:o,nodeMap:c,sidMap:u,clones:p,find:t,reg:d,getState:e=>t(e).meta.wrapped.getState(),graphite:a({family:{type:"domain",links:[f,...p]},meta:{unit:'fork'},scope:{forkInFlightCounter:f}})}})(e);if(n&&(()=>{let r=b(e),a={},n={},s=new Set,f=new Set,c=Object.getOwnPropertyNames(t);i(r,(({reg:e,meta:t})=>{let{nativeTemplate:r}=t;l(e,((e,t)=>{a[t]=e,r&&f.add(t)}))})),i(o.clones,(e=>{let{reg:r}=e,{unit:a,sid:i}=e.meta;if(a===x&&i&&We(c,i)){let{state:a}=e.scope;r[a.id].current=t[i],s.add(a),o.changedStores.add(e.meta.forkOf.id)}l(r,((e,t)=>{n[t]=e}))})),i(k(g(a),f),(e=>{((e,t)=>{let r=0;if(t&&t.before&&!s.has(e)&&i(t.before,(t=>{switch(t.type){case S:e.current=t.fn(n[t.from.id].current);break;case'field':{let a=n[t.from.id];r||(r=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[t.field]=a.current;break}}})),!t||!t.after)return;let a=e.current;i(t.after,(e=>{let t=n[e.to.id];switch(e.type){case'copy':t.current=a;break;case S:t.current=e.fn(a)}}))})(n[e],a[e])}))})(),r){r=y(r,(e=>!C(e)&&F("Handlers map can contain only effects as keys")));let e=Object.keys(r);i(o.clones,(({scope:t,meta:a})=>{a.sid&&We(e,a.sid)&&(t.runner.scope.getHandler=()=>r[a.sid])}))}return o},exports.forward=Ke,exports.fromObservable=e=>{D(e);let t=w in e?e[w]():e;t.subscribe||F('expect observable to have .subscribe');let r=f(),a=W(Ue,r,void 0);return t.subscribe({next:r,error:a,complete:a}),r},exports.guard=(...e)=>{let r={op:'guard'},n='guard',[[o,s],l]=ze(e);l&&(r.config=l,l.name&&(n=l.name)),s||(s=o,o=s.source);let{filter:i,greedy:c,clock:p,name:d=n}=s,g=s.target||f(d,r.config),y=q(i),k=1;return void 0===o&&(t(p,'guard','clock'),Array.isArray(p)&&(p=m(p)),o=p,k=0),k&&!q(o)&&(o=u(o)),p&&(t(p,'guard','clock'),o=h({source:o,clock:p,greedy:c,fn:y?null:(e,t)=>({source:e,clock:t})})),t(g,'guard','target'),y?h({source:i,clock:o,target:a({node:[J({fn:({guard:e})=>e}),V({fn:({data:e})=>e})],child:g,meta:r,family:{owners:[o,i,g,...[].concat(p||[])],links:g},regional:1}),fn:(e,t)=>({guard:e,data:t}),greedy:c,name:d}):(_(i)||F('`filter` should be function or unit'),Je(o,g,{scope:{fn:i},node:p?[J({fn:({source:e,clock:t},{fn:r})=>r(e,t)}),V({fn:({source:e})=>e})]:[J({fn:te})],meta:r})),g},exports.hydrate=(e,{values:t})=>{let r=R(e)&&e.cloneOf;O(e)||r||F('first argument of hydrate should be domain or scope'),R(t)||F('values property should be an object');let a,o,s=y(t);if(r)a=[],o=[],l(s,((t,r)=>{let n=e.sidMap[r];n&&(a.push(n),o.push(t),e.changedStores.add(n.meta.forkOf.id))}));else{let t=(({flatGraphUnits:e,values:t,collectWatches:r})=>{let a=[],n=[],o={},s=new Set,f=Object.getOwnPropertyNames(t);return i(e,(e=>{let{reg:i}=e,{op:c,unit:u,sid:p}=e.meta;if(u===x&&p&&We(f,p)){let{state:r}=e.scope;r.current=t[p],s.add(r)}if(r&&'watch'===c){let t=e.family.owners[0];t.meta.unit===x&&(a.push(e),n.push(t.scope.state))}l(i,((e,t)=>{o[t]=e}))})),i(k(g(o)),(e=>{(e=>{let t=0;if(e.before&&!s.has(e)&&i(e.before,(r=>{switch(r.type){case S:e.current=r.fn(r.from.current);break;case'field':{let a=r.from;t||(t=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[r.field]=a.current;break}}})),!e.after)return;let r=e.current;i(e.after,(e=>{let t=e.to;switch(e.type){case'copy':t.current=r;break;case S:t.current=e.fn(r)}}))})(o[e])})),{storeWatches:a,storeWatchesRefs:n}})({flatGraphUnits:b(e),values:s,collectWatches:1});a=t.storeWatches,o=t.storeWatchesRefs.map((({current:e})=>e))}n({target:a,params:o,forkPage:r?e:0})},exports.is=P,exports.launch=n,exports.merge=m,exports.restore=(e,t,r)=>{if(A(e))return e;if(q(e)){let a,n=ce(e);return j(e)&&(a=c(t,{parent:n,name:e.shortName,ɔ:r}).on(e,((e,t)=>t))),C(e)&&(a=c(t,{parent:n,name:e.shortName,ɔ:r}).on(e.done,((e,{result:t})=>t))),n&&n.hooks.store(a),a}let a=Array.isArray(e)?[]:{};return l(e,((e,t)=>{a[t]=A(e)?e:c(e,{name:t})})),a},exports.sample=h,exports.scopeBind=e=>{je||F('scopeBind cannot be called outside of forked .watch');let t=je,r=je.find(e);return C(e)?e=>{let a=p();n({target:r,params:{params:e,req:a},forkPage:t})}:e=>(n({target:r,params:e,forkPage:t}),e)},exports.serialize=({clones:e,changedStores:t},{ignore:r=[],onlyChanges:a}={})=>{let n={};return i(e,(({meta:e,scope:r,reg:o})=>{if(e.unit!==x)return;let{sid:s}=e;s&&(!a&&!e.isCombine||t.has(e.forkOf.id))&&(n[s]=o[r.state.id].current)})),i(r,(({sid:e})=>{e&&delete n[e]})),n},exports.setStoreName=(e,t)=>{let r=s(t,ce(e));if(e.shortName=t,!e.compositeName)return void(e.compositeName=r);let a=e.compositeName;a.path=r.path,a.shortName=r.shortName,a.fullName=r.fullName},exports.split=(...e)=>{let t,[[r,n],o]=ze(e),s=!n;s&&(t=r.cases,n=r.match,r=r.source);let i=A(n),c=!q(n)&&_(n),u=!i&&!c&&R(n);t||(t={}),s||(u||F('match should be an object'),l(n,((e,r)=>{t[r]=f(o)})),t.__=f(o));let p,d=me(),m=new Set([].concat(r,Object.values(t))),h=Object.keys(i||c?t:n);if(i||c)i&&m.add(n),p=[i&&B({priority:'sampler'}),i&&G({store:oe(n),to:'a'}),J({fn(e,t,r){let a=String(i?r.a:n(e));ut(t,We(h,a)?a:'__',e,r)}})];else if(u){let e=X({});e.type='shape';let t,r=e.before=[],a=[G({store:e,to:"a"}),V({fn(e,{key:t},{a:r}){r[t]=e}})],o=[];l(n,((n,s)=>{if(q(n)){t=1,o.push(s),m.add(n);let l=Je(n,[],{node:a,scope:{key:s}});if(A(n)){e.current[s]=n.getState();let t=oe(n);r.push({type:'field',field:s,from:t}),d&&(We(d.plain,t)||l.seq.unshift(d.loader))}}})),t&&d&&d.plain.push(e),p=[t&&B({priority:'sampler'}),t&&G({store:e,to:'a'}),J({fn(e,t,r){for(let a=0;a<h.length;a++){let s=h[a];if(We(o,s)?r.a[s]:n[s](e))return void ut(t,s,e,r)}ut(t,'__',e,r)}})]}else F('expect match to be unit, function or object');if(a({meta:{onCopy:Object.keys(t),op:'split'},parent:r,scope:t,node:p,family:{type:'crosslink',owners:Array.from(m)},regional:1}),!s)return t},exports.step=Q,exports.version="21.8.12",exports.withFactory=({sid:e,name:t,loc:n,method:o,fn:s})=>r(a({meta:{sidRoot:he(e),name:t,loc:n,method:o}}),s),exports.withRegion=r;
//# sourceMappingURL=effector.cjs.js.map
