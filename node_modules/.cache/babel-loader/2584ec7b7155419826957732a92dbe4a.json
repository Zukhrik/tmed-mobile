{"ast":null,"code":"import _regeneratorRuntime from\"/Users/zuhriddinkamilzanov/Desktop/t-med(mobile)/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/zuhriddinkamilzanov/Desktop/t-med(mobile)/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/zuhriddinkamilzanov/Desktop/t-med(mobile)/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{useStore}from'effector-react';import{v4 as uuidV4}from'uuid';import{fileToBase64}from'../../utils/crop-utils';import{$accountModel}from'../../Models/account-model';import moment from'moment';import{$tapeModel,creatingPostMediaMount,creatingPostMount,deleteUnCreatedPostMediaMount,postMediaPercentCompletedMount,resetPostMedia}from'../../Models/tape-model';import post from'../../Service/post';import{useOutsideClicker}from'../app/use-outside-clicker';import{useCallback,useEffect,useRef,useState}from'react';export function useCreatingPost(setCreatePost){var postRef=useRef(null);var _useOutsideClicker=useOutsideClicker(postRef),clicked=_useOutsideClicker.clicked;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),file=_useState2[0],setFile=_useState2[1];var _useState3=useState(''),_useState4=_slicedToArray(_useState3,2),title=_useState4[0],setTitle=_useState4[1];var _useState5=useState([]),_useState6=_slicedToArray(_useState5,2),images=_useState6[0],setImages=_useState6[1];var _useStore=useStore($accountModel),currentProfile=_useStore.$profiles.currentProfile;var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),showPostForm=_useState8[0],setShowPostForm=_useState8[1];var _useStore2=useStore($tapeModel),medias=_useStore2.$postMedia.data;var author=currentProfile&&\"@\".concat(currentProfile.slug_name);var resetLocalStates=useCallback(function(){setTitle('');setFile([]);setImages([]);setShowPostForm(false);},[]);var createPostMedia=useCallback(function(data){post.createPostMediaId(data);},[]);var createPost=useCallback(function(){var uuid=uuidV4();var mediaStrings=[];var mediaIds=[];var allow=true;if(medias.length>0){for(var i=0;i<medias.length;i++){mediaIds.push({gallery_id:medias[i].id});mediaStrings.push({id:medias[i].id,image:medias[i].stringUrl,thumbnail:medias[i].stringUrl});if(typeof medias[i].id!=='number'){allow=false;break;}}}if(allow){var action=function action(id){resetLocalStates();if(mediaIds.length>0){var params={post_id:id,data:mediaIds};createPostMedia(params);resetPostMedia();}};var block_data={action:null,id:uuid,author:{type:'user',name:currentProfile.name,avatar:currentProfile.avatar,slug_name:currentProfile.slug_name,is_official:currentProfile.isOfficial},medias:mediaStrings.length>0?mediaStrings:[],thumbnail:mediaStrings.length>0?mediaStrings:[],date:moment().format('YYYY-MM-DD'),text:title};var temp_data={item_data:{block_type:'post',block_data:block_data},uuid:uuid,author:author,action:action};creatingPostMount({data:{text:title},temp_data:temp_data});}},[title,resetLocalStates,createPostMedia,medias,author,currentProfile]);var _onUploadProgress=useCallback(function(evt,id){var percentCompleted=Math.round(evt.loaded*100/evt.total);postMediaPercentCompletedMount({id:id,percentCompleted:percentCompleted});},[]);var handleAddFiles=useCallback(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(files){var filesArr,i,base64Url;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:filesArr=Array.from(files);i=0;case 2:if(!(i<filesArr.length)){_context.next=10;break;}_context.next=5;return fileToBase64(filesArr[i]);case 5:base64Url=_context.sent;if(typeof base64Url==='string'){(function(){var uuid=uuidV4();var formData=new FormData();formData.append('image',filesArr[i]);creatingPostMediaMount({data:formData,post_id:0,onUploadProgress:function onUploadProgress(e){return _onUploadProgress(e,uuid);},obj:{// id: uuid,\nstringUrl:base64Url,percentCompleted:0}});})();}case 7:i++;_context.next=2;break;case 10:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}(),[_onUploadProgress]);var handleDeleted=useCallback(function(item){if(item){var params={post_id:0,media_id:item.id};deleteUnCreatedPostMediaMount(params);}},[]);var handleSubmit=useCallback(function(){if(medias.length>0||title.trim().length>0){createPost();setCreatePost(false);}},[title,createPost,medias,setCreatePost]);useEffect(function(){if(clicked){setShowPostForm(false);}},[clicked]);return{file:file,title:title,images:images,setFile:setFile,postRef:postRef,setTitle:setTitle,handleSubmit:handleSubmit,showPostForm:showPostForm,handleDeleted:handleDeleted,handleAddFiles:handleAddFiles,setShowPostForm:setShowPostForm};}","map":null,"metadata":{},"sourceType":"module"}