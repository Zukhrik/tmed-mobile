{"ast":null,"code":"import _defineProperty from\"/Users/zuhriddinkamilzanov/Desktop/t-med(mobile)/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _toConsumableArray from\"/Users/zuhriddinkamilzanov/Desktop/t-med(mobile)/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _objectSpread from\"/Users/zuhriddinkamilzanov/Desktop/t-med(mobile)/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import{combine,createStore}from'effector';import{fetchAllChatList,fetchChatAllGroup,fetchChatAllOrg,fetchChatAllUser,fetchGroupChats,fetchSentMessage,fetchUpdateMessage,fetchUserDetailChat}from'./effects';import{addedMessageFromSocket,addedMessageToListFromSocket,chatForceLoading,chatSocketActionsMount,removeMessageEvent,temporaryMessageMount,updateChatFromSocket,updateCounterFromSocket,userMessageUploadProgress,userSentMessageMount,userUpdateMessageMount}from'./events';import{URL_VALUES}from'../../Constants';import{storeListWithKey}from'../../utils/store-utils';import moment from'moment';var $allChatList=createStore({loading:false,userChats:{},groupChats:{},userChatResult:{},groupChatResult:{},error:false,userChatForceLoading:0,groupChatForCeLoading:0}).on(fetchAllChatList.pending,function(state,loading){return _objectSpread(_objectSpread({},state),{},{loading:loading});}).on(fetchAllChatList.done,function(state,_ref){var error=_ref.error;return _objectSpread(_objectSpread({},state),{},{data:[],error:error,result:{},forceLoading:0});}).on(fetchAllChatList.done,function(state,_ref2){var result=_ref2.result,params=_ref2.params;var userChats=_objectSpread({},state.userChats);var groupChats=_objectSpread({},state.groupChats);var userChatResult={};var groupChatResult={};var userChatForceLoading=0;var groupChatForCeLoading=0;var data=result.data.results;if(params.params.rtype==='user'){for(var i=0;i<data.length;i++){userChats[data[i].receiver.username]=data[i];}userChatForceLoading=2;userChatResult=_objectSpread({nextOffset:params.params.offset+10},result.data);}return _objectSpread(_objectSpread({},state),{},{result:result.data,userChatResult:userChatResult,userChats:userChats,groupChatResult:groupChatResult,groupChats:groupChats,userChatForceLoading:userChatForceLoading,groupChatForCeLoading:groupChatForCeLoading});}).on(addedMessageToListFromSocket,function(state,_ref3){var type=_ref3.type,key=_ref3.key,payload=_ref3.payload;var userChats=_objectSpread({},state.userChats);if(type==='user'){if(state.userChatForceLoading===2){userChats[key]=userChats[key]?_objectSpread(_objectSpread({},userChats[key]),payload):payload;}}return _objectSpread(_objectSpread({},state),{},{userChats:userChats});}).on(updateCounterFromSocket,function(state,_ref4){var type=_ref4.type,key=_ref4.key,payload=_ref4.payload;var userChats=_objectSpread({},state.userChats);if(type==='user'){if(state.userChatForceLoading===2){userChats[key]=userChats[key]?_objectSpread(_objectSpread({},userChats[key]),payload):payload;}}return _objectSpread(_objectSpread({},state),{},{userChats:userChats});}).on(fetchSentMessage.done,function(state,_ref5){var result=_ref5.result,params=_ref5.params;var receiver=params.receiver;var userChats=_objectSpread({},state.userChats);if(state.userChatForceLoading===2&&userChats[receiver]){userChats[receiver]=_objectSpread(_objectSpread({},userChats[receiver]),{},{last_message:_objectSpread(_objectSpread({},userChats[receiver].last_message),{},{text:result.data.text})});}return _objectSpread(_objectSpread({},state),{},{userChats:userChats});}).on(chatForceLoading,function(state,_ref6){var type=_ref6.type;var userChatForceLoading=0;var groupChatForCeLoading=0;if(type===URL_VALUES.ALL_CHATS){userChatForceLoading=1;}if(type===URL_VALUES.GROUP_CHATS){groupChatForCeLoading=1;}return _objectSpread(_objectSpread({},state),{},{userChatForceLoading:userChatForceLoading,groupChatForCeLoading:groupChatForCeLoading});});var $groupChatList=createStore({loading:false,data:[],result:{},error:false,forceLoading:0}).on(fetchGroupChats.pending,function(state,loading){return _objectSpread(_objectSpread({},state),{},{loading:loading});}).on(fetchGroupChats.done,function(state,_ref7){var error=_ref7.error;return _objectSpread(_objectSpread({},state),{},{data:[],error:error,result:{},forceLoading:0});}).on(fetchGroupChats.done,function(state,_ref8){var result=_ref8.result,params=_ref8.params;var data=params.clear?result.data.results:[].concat(_toConsumableArray(state.data),_toConsumableArray(result.data.results));return _objectSpread(_objectSpread({},state),{},{result:result.data,data:data,forceLoading:2});}).on(chatForceLoading,function(state,_ref9){var type=_ref9.type;return _objectSpread(_objectSpread({},state),{},{forceLoading:type===URL_VALUES.GROUP_CHATS?1:0});});var $userMessages=createStore({loading:true,result:{},partner:{},error:false,typing:{},messages:{}}).on(fetchUserDetailChat.pending,function(state,loading){return _objectSpread(_objectSpread({},state),{},{loading:loading});}).on(fetchUserDetailChat.fail,function(state,_ref10){var error=_ref10.error;return _objectSpread(_objectSpread({},state),{},{error:error,data:{},result:{}});}).on(fetchUserDetailChat.done,function(state,_ref11){var response=_ref11.result,params=_ref11.params;var offset=params.params.offset,clear=params.clear,key=params.partner;var result=_objectSpread({},state.result);var partner=_objectSpread({},state.sender);var typing=_objectSpread({},state.typing);var nextOffset=offset+20;result[key]=_objectSpread(_objectSpread({},response.data),{},{nextOffset:nextOffset});partner[key]=response.data.partner;typing[key]=false;var messages=_objectSpread({},state.messages);var tmp=response.data.results.reduce(function(acc,cur){var date=moment(cur.date).format('YYYY-MM-DD');acc[date]=acc[date]?[_objectSpread({},cur)].concat(_toConsumableArray(acc[date])):[_objectSpread({},cur)];return acc;},{});var tmp2={};if(messages[key]){for(var date in messages[key]){if(messages[key].hasOwnProperty(date)){if(tmp[date]){var concated=[].concat(_toConsumableArray(messages[key][date]),_toConsumableArray(tmp[date])).reduce(function(acc,cur){var i=acc.findIndex(function(m){return m.id===cur.id;});if(!~i||!acc[i].checked){acc.push(cur);if(~i){acc.splice(i,1);}}return acc;},[]);tmp2[date]=concated.sort(function(a,b){return new Date(a.date).getTime()-new Date(b.date).getTime();});}}}}messages[key]=clear?tmp:_objectSpread(_objectSpread(_objectSpread({},state.messages[key]),tmp),tmp2);return _objectSpread(_objectSpread({},state),{},{result:result,partner:partner,typing:typing,messages:messages});}).on(addedMessageFromSocket,function(state,_ref12){var key=_ref12.key,payload=_ref12.payload;var result=_objectSpread({},state.result);var messages=_objectSpread({},state.messages);var date=moment(payload.date).format('YYYY-MM-DD');messages[key]=messages[key]?_objectSpread({},messages[key]):{};messages[key][date]=messages[key][date]?[].concat(_toConsumableArray(messages[key][date]),[_objectSpread({},payload)]):[_objectSpread({},payload)];return _objectSpread(_objectSpread({},state),{},{result:result,messages:messages});}).on(userSentMessageMount,function(state,_ref13){var payload=_ref13.payload,partner=_ref13.partner,uuid=_ref13.uuid;var messages=_objectSpread({},state.messages);var date=moment(payload.date).format('YYYY-MM-DD');messages[partner][date]=messages[partner][date]?[].concat(_toConsumableArray(messages[partner][date]),[_objectSpread(_objectSpread({},payload),{},{id:uuid,sent:true,uploadStatus:0,dataSrc:true})]):[_objectSpread(_objectSpread({},payload),{},{sent:true})];return _objectSpread(_objectSpread({},state),{},{messages:messages});}).on(userMessageUploadProgress,function(state,_ref14){var partner=_ref14.partner,payload=_ref14.payload,status=_ref14.status;var messages=_objectSpread({},state.messages);var date=moment(payload.date).format('YYYY-MM-DD');var idx=messages[partner][date].findIndex(function(item){return item.id===payload.id;});var oldItem=_objectSpread(_objectSpread({},messages[partner][date][idx]),{},{uploadStatus:status});messages[partner][date]=[].concat(_toConsumableArray(messages[partner][date].slice(0,idx)),[_objectSpread({},oldItem)],_toConsumableArray(messages[partner][date].slice(idx+1)));return _objectSpread(_objectSpread({},state),{},{messages:messages});}).on(userUpdateMessageMount,function(state,_ref15){var payload=_ref15.payload,partner=_ref15.partner;var messages=_objectSpread({},state.messages);var date=moment(payload.date).format('YYYY-MM-DD');var idx=messages[partner][date].findIndex(function(item){return item.id===payload.id;});var oldItem=_objectSpread(_objectSpread(_objectSpread({},messages[partner][date][idx]),payload),{},{sent:true});messages[partner][date]=[].concat(_toConsumableArray(messages[partner][date].slice(0,idx)),[_objectSpread({},oldItem)],_toConsumableArray(messages[partner][date].slice(idx+1)));return _objectSpread(_objectSpread({},state),{},{messages:messages});}).on(removeMessageEvent,function(state,_ref16){var id=_ref16.id,key=_ref16.key,date=_ref16.date;var messages=_objectSpread({},state.messages);messages[key][date]=messages[key][date].filter(function(item){return item.id!==id;});return _objectSpread(_objectSpread({},state),{},{messages:messages});}).on(fetchSentMessage.done,function(state,_ref17){var response=_ref17.result,params=_ref17.params;var partner=params.partner,uuid=params.uuid;var date=moment(response.data.date).format('YYYY-MM-DD');var result=_objectSpread({},state.result);result[partner]=_objectSpread(_objectSpread({},result),{},{count:result.count+1});var messages=_objectSpread({},state.messages);var data=messages[partner][date];var idx=data.findIndex(function(item){return item.id===uuid;});messages[partner][date]=[].concat(_toConsumableArray(data.slice(0,idx)),[_objectSpread(_objectSpread({},response.data),{},{file:messages[partner][date][idx].file,dataSrc:response.data.file})],_toConsumableArray(data.slice(idx+1)));return _objectSpread(_objectSpread({},state),{},{result:result,messages:messages});}).on(fetchUpdateMessage.done,function(state,_ref18){var response=_ref18.result,params=_ref18.params;var partner=params.partner,id=params.id;var date=moment(response.data.date).format('YYYY-MM-DD');var result=_objectSpread({},state.result);result[partner]=_objectSpread(_objectSpread({},result),{},{count:result.count+1});var messages=_objectSpread({},state.messages);var data=messages[partner][date];var idx=data.findIndex(function(item){return item.id===id;});messages[partner][date]=[].concat(_toConsumableArray(data.slice(0,idx)),[_objectSpread(_objectSpread({},messages[partner][date][idx]),{},{updated:response.data.updated,sent:false})],_toConsumableArray(data.slice(idx+1)));return _objectSpread({},state);}).on(updateChatFromSocket,function(state,_ref19){var id=_ref19.id,username=_ref19.username,action=_ref19.action,typingStatus=_ref19.typing;var data=_objectSpread({},state.data);var typing=_objectSpread({},state.typing);var arr=data[username];if(arr&&arr.length>0&&action==='read'){var idx=arr.findIndex(function(item){return item.id===id;});var item=arr.find(function(item){return item.id===id;});data[username]=[].concat(_toConsumableArray(data[username].slice(0,idx)),[_objectSpread(_objectSpread({},item),{},{is_read:true})],_toConsumableArray(data[username].slice(idx+1)));}if(action==='typing'){typing[username]=typingStatus;}return _objectSpread(_objectSpread({},state),{},{typing:typing,data:data});});var $chatSocketActions=createStore({chatActionSendMessage:function chatActionSendMessage(){return null;}}).on(chatSocketActionsMount,function(state,payload){return _objectSpread(_objectSpread({},state),payload);});var getStatus=function getStatus(status){return status&&status===2?status:1;};var $searchContact=createStore({data:{},result:{},forceLoading:{},error:{}}).on(fetchChatAllUser.pending,function(state,loading){return _objectSpread(_objectSpread({},state),{},{loading:loading,forceLoading:_objectSpread(_objectSpread({},state.forceLoading),{},_defineProperty({},URL_VALUES.PEOPLE,getStatus(state.forceLoading[URL_VALUES.PEOPLE])))});}).on(fetchChatAllUser.fail,function(state,_ref20){var error=_ref20.error;return _objectSpread(_objectSpread({},state),{},{error:_objectSpread(_objectSpread({},state.error),{},_defineProperty({},URL_VALUES.PEOPLE,error)),result:_objectSpread(_objectSpread({},state.result),{},_defineProperty({},URL_VALUES.PEOPLE,false))});}).on(fetchChatAllUser.done,function(state,_ref21){var result=_ref21.result,params=_ref21.params;var processed=storeListWithKey(_objectSpread({state:state,response:result.data,key:URL_VALUES.PEOPLE,clear:params.clear},params.params));return _objectSpread(_objectSpread(_objectSpread({},state),processed),{},{forceLoading:_objectSpread(_objectSpread({},state.forceLoading),{},_defineProperty({},URL_VALUES.PEOPLE,2)),error:_objectSpread(_objectSpread({},state.error),{},_defineProperty({},URL_VALUES.PEOPLE,false))});}).on(fetchChatAllOrg.pending,function(state,loading){return _objectSpread(_objectSpread({},state),{},{loading:loading,forceLoading:_objectSpread(_objectSpread({},state.forceLoading),{},_defineProperty({},URL_VALUES.ORGANIZATION,getStatus(state.forceLoading[URL_VALUES.ORGANIZATION])))});}).on(fetchChatAllOrg.fail,function(state,_ref22){var error=_ref22.error;return _objectSpread(_objectSpread({},state),{},{error:_objectSpread(_objectSpread({},state.error),{},_defineProperty({},URL_VALUES.ORGANIZATION,error)),result:_objectSpread(_objectSpread({},state.result),{},_defineProperty({},URL_VALUES.ORGANIZATION,false))});}).on(fetchChatAllOrg.done,function(state,_ref23){var result=_ref23.result,params=_ref23.params;var processed=storeListWithKey(_objectSpread({state:state,response:result.data,key:URL_VALUES.ORGANIZATION,clear:params.clear},params.params));return _objectSpread(_objectSpread(_objectSpread({},state),processed),{},{forceLoading:_objectSpread(_objectSpread({},state.forceLoading),{},_defineProperty({},URL_VALUES.ORGANIZATION,2)),error:_objectSpread(_objectSpread({},state.error),{},_defineProperty({},URL_VALUES.ORGANIZATION,false))});}).on(fetchChatAllGroup.pending,function(state,loading){return _objectSpread(_objectSpread({},state),{},{loading:loading,forceLoading:_objectSpread(_objectSpread({},state.forceLoading),{},_defineProperty({},URL_VALUES.GROUP,getStatus(state.forceLoading[URL_VALUES.GROUP])))});}).on(fetchChatAllGroup.fail,function(state,_ref24){var error=_ref24.error;return _objectSpread(_objectSpread({},state),{},{error:_objectSpread(_objectSpread({},state.error),{},_defineProperty({},URL_VALUES.GROUP,error)),result:_objectSpread(_objectSpread({},state.result),{},_defineProperty({},URL_VALUES.GROUP,false))});}).on(fetchChatAllGroup.done,function(state,_ref25){var result=_ref25.result,params=_ref25.params;var processed=storeListWithKey(_objectSpread({state:state,response:result.data,key:URL_VALUES.GROUP,clear:params.clear},params.params));return _objectSpread(_objectSpread(_objectSpread({},state),processed),{},{forceLoading:_objectSpread(_objectSpread({},state.forceLoading),{},_defineProperty({},URL_VALUES.GROUP,2)),error:_objectSpread(_objectSpread({},state.error),{},_defineProperty({},URL_VALUES.GROUP,false))});});var $temporaryMessage=createStore(null).on(temporaryMessageMount,function(state,payload){return payload;});// $userMessages.watch(console.log)\nexport var $chatModel=combine({$allChatList:$allChatList,$temporaryMessage:$temporaryMessage,$userMessages:$userMessages,$groupChatList:$groupChatList,$searchContact:$searchContact,$chatSocketActions:$chatSocketActions});","map":null,"metadata":{},"sourceType":"module"}