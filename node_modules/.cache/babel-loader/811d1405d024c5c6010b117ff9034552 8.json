{"ast":null,"code":"import moment from 'moment';\nimport { useCallback, useEffect, useState } from 'react';\nimport { useUrlParams } from '../app';\nimport { URL_KEYS } from '../../Constants';\nimport { useStore } from 'effector-react';\nimport { formatter, strHourToInt } from './use-specialist-date';\nimport { getDateTime, getWeekDay } from '../../utils/time-utils';\nimport { $orderModel } from '../../Models/order-model';\nimport order from '../../Service/order';\nimport { useHistory, useParams } from 'react-router-dom';\nexport function useSpecMeetDate({\n  activeDay\n}) {\n  var _data$organization$, _data$organization$$r;\n\n  const {\n    organization\n  } = useParams();\n  const [activeDate] = useState(new Date());\n  const {\n    push,\n    location: {\n      pathname\n    }\n  } = useHistory();\n  const {\n    $orgOrderCartList: {\n      data\n    }\n  } = useStore($orderModel);\n  const [dateRange, setDateRange] = useState([]);\n  const [meetTimes, setMeetTimes] = useState({});\n  const [hours, setHours] = useState([]);\n  const [procInterval, setProcInterval] = useState(false);\n  const [requestData, setRequestData] = useState({});\n  const operating_modes = organization && data[organization] && ((_data$organization$ = data[organization][0]) === null || _data$organization$ === void 0 ? void 0 : (_data$organization$$r = _data$organization$.responsible) === null || _data$organization$$r === void 0 ? void 0 : _data$organization$$r.operating_mode);\n  const {\n    urlData\n  } = useUrlParams();\n  const specId = urlData[URL_KEYS.SPECIALIST_ID];\n  const generateData = useCallback(data => {\n    const tmp = {};\n\n    for (let i = 0; i < data.length; i++) {\n      const id = new Date(moment(data[i].meet_date).format(formatter)).getTime();\n      const meetTime = moment(data[i].meet_date).format('HH.mm');\n      tmp[id] = {\n        user: data[i].user,\n        meetTime: parseFloat(parseFloat(meetTime).toFixed(1))\n      };\n    }\n\n    return tmp;\n  }, []);\n  const getOrgOrder = useCallback(params => {\n    order.getOrgOrderResponsible(params).then(res => {\n      const data = res.data.results;\n      let orders = generateData(data);\n      setRequestData(orders);\n    });\n  }, [generateData]);\n  const renderMeetRow = useCallback(id => {\n    const strHour = moment(id).format('HH:mm');\n    const hourInt = strHourToInt(strHour);\n    return meetTimes[hourInt] && Object.values(meetTimes[hourInt]).sort((a, b) => a - b);\n  }, [meetTimes]);\n  const generateMeetTimeLink = useCallback(() => {\n    const url = [];\n\n    if (specId) {\n      url.push(`${URL_KEYS.SPECIALIST_ID}=${specId}`);\n    }\n\n    url.push(`${URL_KEYS.DATE}=${activeDay}`);\n    url.push(`${URL_KEYS.TIME}=00:00:00`);\n    return {\n      pathname,\n      search: url.join('&')\n    };\n  }, [activeDay, pathname, specId]);\n  useEffect(() => {\n    const endDate = moment(activeDate).endOf('month');\n    let start = activeDate.getUTCDate();\n    const end = new Date(endDate).getUTCDate();\n    const tmp = [];\n\n    for (let i = 0; i <= end - start; i++) {\n      const d = moment(activeDate).add(i, 'days');\n      tmp.push(d.format('YYYY-MM-DD'));\n    }\n\n    setDateRange(tmp);\n  }, [activeDate]);\n  useEffect(() => {\n    const day = getWeekDay(new Date());\n\n    if (operating_modes && operating_modes[day]) {\n      const mode = operating_modes[day];\n      const breaks = mode.breaks;\n      const to = mode.to;\n      const interval = mode.proc_interval;\n      const tmp = [];\n      const possibleMeetTime = {};\n      let from = parseInt(mode.from);\n      let a = mode.from;\n      const date = new Date(activeDay);\n\n      if (interval !== 0) {\n        while (a < to) {\n          for (let i = 0; i < breaks.length; i++) {\n            if (parseInt(a) === parseInt(breaks[i].from) && (breaks[i].from >= a || a < breaks[i].to)) {\n              a = breaks[i].to;\n            }\n          }\n\n          possibleMeetTime[parseInt(a)] = possibleMeetTime[parseInt(a)] ? { ...possibleMeetTime[parseInt(a)]\n          } : {};\n          const strHour = moment(new Date(new Date(getDateTime(a)).setMinutes(new Date(getDateTime(a === from ? mode.from : a)).getMinutes() + interval)));\n          const id = moment(new Date(`${date.toDateString()} ${moment(getDateTime(a)).format('HH:mm')}`)).format(formatter);\n          possibleMeetTime[parseInt(a)][id] = {\n            intDate: a,\n            strDate: `${moment(getDateTime(a)).format('HH:mm')} - ${strHour.format('HH:mm')}`,\n            dateTime: new Date(new Date(`${date.toDateString()} ${moment(getDateTime(a)).format('HH:mm')}`)).getTime()\n          };\n          a = parseFloat(strHour.format('HH.mm'));\n        }\n\n        setMeetTimes(possibleMeetTime);\n\n        for (let i = from; i < to; i++) {\n          const id = new Date(new Date(`${date.toDateString()} 0${i}:59`)).getTime();\n\n          if (i < 10) {\n            tmp.push({\n              hour: `0${i}:00`,\n              interval,\n              id\n            });\n          } else {\n            tmp.push({\n              hour: `${i}:00`,\n              interval,\n              id\n            });\n          }\n        }\n\n        setHours(tmp);\n      } else {\n        setProcInterval(true);\n      }\n    }\n  }, [operating_modes, activeDay]);\n  useEffect(() => {\n    if (specId && activeDay) {\n      const data = {\n        responsible_id: specId,\n        params: {\n          status: '0,1,2',\n          limit: 200,\n          offset: 0,\n          meet_date__gt: moment(new Date(`${new Date(activeDay).toDateString()} 00:00`)).format(formatter),\n          meet_date__lt: moment(new Date(`${new Date(activeDay).toDateString()} 23:59`)).format(formatter)\n        }\n      };\n      getOrgOrder(data);\n    }\n  }, [specId, getOrgOrder, activeDay]);\n  useEffect(() => {\n    if (procInterval) {\n      push(generateMeetTimeLink());\n    }\n  }, [procInterval, generateMeetTimeLink, push]);\n  return {\n    dateRange,\n    activeDate,\n    hours,\n    renderMeetRow,\n    requestData\n  };\n}","map":{"version":3,"sources":["/Users/zuhriddinkamilzanov/Desktop/tMed-mobile/src/Hooks/checkout/use-spec-meet-date.js"],"names":["moment","useCallback","useEffect","useState","useUrlParams","URL_KEYS","useStore","formatter","strHourToInt","getDateTime","getWeekDay","$orderModel","order","useHistory","useParams","useSpecMeetDate","activeDay","organization","activeDate","Date","push","location","pathname","$orgOrderCartList","data","dateRange","setDateRange","meetTimes","setMeetTimes","hours","setHours","procInterval","setProcInterval","requestData","setRequestData","operating_modes","responsible","operating_mode","urlData","specId","SPECIALIST_ID","generateData","tmp","i","length","id","meet_date","format","getTime","meetTime","user","parseFloat","toFixed","getOrgOrder","params","getOrgOrderResponsible","then","res","results","orders","renderMeetRow","strHour","hourInt","Object","values","sort","a","b","generateMeetTimeLink","url","DATE","TIME","search","join","endDate","endOf","start","getUTCDate","end","d","add","day","mode","breaks","to","interval","proc_interval","possibleMeetTime","from","parseInt","date","setMinutes","getMinutes","toDateString","intDate","strDate","dateTime","hour","responsible_id","status","limit","offset","meet_date__gt","meet_date__lt"],"mappings":"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","sourcesContent":["import moment from 'moment'\nimport {useCallback, useEffect, useState} from 'react'\nimport {useUrlParams} from '../app'\nimport {URL_KEYS} from '../../Constants'\nimport {useStore} from 'effector-react'\nimport {formatter, strHourToInt} from './use-specialist-date'\nimport {getDateTime, getWeekDay} from '../../utils/time-utils'\nimport {$orderModel} from '../../Models/order-model'\nimport order from '../../Service/order'\nimport {useHistory, useParams} from 'react-router-dom'\n\nexport function useSpecMeetDate({activeDay}) {\n    const {organization} = useParams()\n    const [activeDate] = useState(new Date())\n    const {push, location: {pathname}} = useHistory()\n    const {$orgOrderCartList: {data}} = useStore($orderModel)\n    const [dateRange, setDateRange] = useState([])\n    const [meetTimes, setMeetTimes] = useState({})\n    const [hours, setHours] = useState([])\n    const [procInterval, setProcInterval] = useState(false)\n    const [requestData, setRequestData] = useState({})\n    const operating_modes = organization && data[organization] && data[organization][0]?.responsible?.operating_mode\n    const {urlData} = useUrlParams()\n    const specId = urlData[URL_KEYS.SPECIALIST_ID]\n    \n    const generateData = useCallback((data) => {\n        const tmp = {}\n        for (let i = 0; i < data.length; i++) {\n            const id = new Date(moment(data[i].meet_date).format(formatter)).getTime()\n            const meetTime = moment(data[i].meet_date).format('HH.mm')\n            tmp[id] = {\n                user: data[i].user,\n                meetTime: parseFloat(parseFloat(meetTime).toFixed(1))\n            }\n        }\n        return tmp\n    }, [])\n    \n    const getOrgOrder = useCallback((params) => {\n        order.getOrgOrderResponsible(params)\n            .then(res => {\n                const data = res.data.results\n                let orders = generateData(data)\n                setRequestData(orders)\n            })\n    }, [generateData])\n    \n    const renderMeetRow = useCallback((id) => {\n        const strHour = moment(id).format('HH:mm')\n        const hourInt = strHourToInt(strHour)\n        return meetTimes[hourInt] && Object.values(meetTimes[hourInt]).sort((a, b) => a - b)\n    }, [meetTimes])\n    \n    const generateMeetTimeLink = useCallback(() => {\n        const url = []\n        if (specId) {\n            url.push(`${URL_KEYS.SPECIALIST_ID}=${specId}`)\n        }\n        url.push(`${URL_KEYS.DATE}=${activeDay}`)\n        url.push(`${URL_KEYS.TIME}=00:00:00`)\n        return {\n            pathname,\n            search: url.join('&')\n        }\n    }, [activeDay, pathname, specId])\n    \n    useEffect(() => {\n        const endDate = moment(activeDate).endOf('month')\n        let start = activeDate.getUTCDate()\n        const end = new Date(endDate).getUTCDate()\n        const tmp = []\n        for (let i = 0; i <= end - start; i++) {\n            const d = moment(activeDate).add(i, 'days')\n            tmp.push(d.format('YYYY-MM-DD'))\n        }\n        \n        setDateRange(tmp)\n    }, [activeDate])\n    \n    \n    useEffect(() => {\n        const day = getWeekDay(new Date())\n        if (operating_modes && operating_modes[day]) {\n            const mode = operating_modes[day]\n            const breaks = mode.breaks\n            const to = mode.to\n            const interval = mode.proc_interval\n            const tmp = []\n            const possibleMeetTime = {}\n            let from = parseInt(mode.from)\n            let a = mode.from\n            const date = new Date(activeDay)\n            \n            if (interval !== 0) {\n                while (a < to) {\n                    \n                    for (let i = 0; i < breaks.length; i++) {\n                        if (parseInt(a) === parseInt(breaks[i].from) && (breaks[i].from >= a || a < breaks[i].to)) {\n                            a = breaks[i].to\n                        }\n                    }\n                    \n                    possibleMeetTime[parseInt(a)] = possibleMeetTime[parseInt(a)]\n                        ? {...possibleMeetTime[parseInt(a)]}\n                        : {}\n                    \n                    const strHour = moment(new Date(new Date(getDateTime(a))\n                        .setMinutes(new Date(getDateTime(a === from ? mode.from : a)).getMinutes() + interval)))\n                    \n                    const id = moment(new Date(`${date.toDateString()} ${moment(getDateTime(a)).format('HH:mm')}`)).format(formatter)\n                    \n                    possibleMeetTime[parseInt(a)][id] = {\n                        intDate: a,\n                        strDate: `${moment(getDateTime(a)).format('HH:mm')} - ${strHour.format('HH:mm')}`,\n                        dateTime: new Date(new Date(`${date.toDateString()} ${moment(getDateTime(a)).format('HH:mm')}`)).getTime()\n                    }\n                    a = parseFloat(strHour.format('HH.mm'))\n                }\n                setMeetTimes(possibleMeetTime)\n                for (let i = from; i < to; i++) {\n                    const id = new Date(new Date(`${date.toDateString()} 0${i}:59`)).getTime()\n                    if (i < 10) {\n                        tmp.push({hour: `0${i}:00`, interval, id})\n                    } else {\n                        tmp.push({hour: `${i}:00`, interval, id})\n                    }\n                }\n                setHours(tmp)\n            } else {\n                setProcInterval(true)\n            }\n        }\n    }, [operating_modes, activeDay])\n    \n    \n    useEffect(() => {\n        if (specId && activeDay) {\n            const data = {\n                responsible_id: specId,\n                params: {\n                    status: '0,1,2',\n                    limit: 200,\n                    offset: 0,\n                    meet_date__gt: moment(new Date(`${new Date(activeDay).toDateString()} 00:00`)).format(formatter),\n                    meet_date__lt: moment(new Date(`${new Date(activeDay).toDateString()} 23:59`)).format(formatter)\n                }\n            }\n            getOrgOrder(data)\n        }\n    }, [specId, getOrgOrder, activeDay])\n    \n    useEffect(() => {\n        if (procInterval) {\n            push(generateMeetTimeLink())\n        }\n    }, [procInterval, generateMeetTimeLink, push])\n    \n    return {dateRange, activeDate, hours, renderMeetRow, requestData}\n}"]},"metadata":{},"sourceType":"module"}