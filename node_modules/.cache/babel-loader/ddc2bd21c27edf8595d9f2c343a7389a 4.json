{"ast":null,"code":"import _regeneratorRuntime from\"/Users/zuhriddinkamilzanov/Desktop/tMed-mobile/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/zuhriddinkamilzanov/Desktop/tMed-mobile/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/zuhriddinkamilzanov/Desktop/tMed-mobile/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{useStore}from'effector-react';import{v4 as uuidV4}from'uuid';import{fileToBase64}from'../../utils/crop-utils';import{$accountModel}from'../../Models/account-model';import moment from'moment';import{$tapeModel,creatingPostMediaMount,creatingPostMount,deleteUnCreatedPostMediaMount,postMediaPercentCompletedMount,resetPostMedia}from'../../Models/tape-model';import post from'../../Service/post';import{useOutsideClicker}from'../app/use-outside-clicker';import{useCallback,useEffect,useRef,useState}from'react';export function useCreatingPost(setCreatePost){var postRef=useRef(null);var _useOutsideClicker=useOutsideClicker(postRef),clicked=_useOutsideClicker.clicked;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),file=_useState2[0],setFile=_useState2[1];var _useState3=useState(''),_useState4=_slicedToArray(_useState3,2),title=_useState4[0],setTitle=_useState4[1];var _useState5=useState([]),_useState6=_slicedToArray(_useState5,2),images=_useState6[0],setImages=_useState6[1];var _useStore=useStore($accountModel),currentProfile=_useStore.$profiles.currentProfile;var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),showPostForm=_useState8[0],setShowPostForm=_useState8[1];var _useStore2=useStore($tapeModel),medias=_useStore2.$postMedia.data;var author=currentProfile&&\"@\".concat(currentProfile.slug_name);var resetLocalStates=useCallback(function(){setTitle('');setFile([]);setImages([]);setShowPostForm(false);},[]);var createPostMedia=useCallback(function(data){post.createPostMediaId(data);},[]);var createPost=useCallback(function(){var uuid=uuidV4();var mediaStrings=[];var mediaIds=[];var allow=true;if(medias.length>0){for(var i=0;i<medias.length;i++){mediaIds.push({gallery_id:medias[i].id});mediaStrings.push({id:medias[i].id,image:medias[i].stringUrl,thumbnail:medias[i].stringUrl});if(typeof medias[i].id!=='number'){allow=false;break;}}}if(allow){var action=function action(id){resetLocalStates();if(mediaIds.length>0){var params={post_id:id,data:mediaIds};createPostMedia(params);resetPostMedia();}};var block_data={action:null,id:uuid,author:{type:'user',name:currentProfile.name,avatar:currentProfile.avatar,slug_name:currentProfile.slug_name,is_official:currentProfile.isOfficial},medias:mediaStrings.length>0?mediaStrings:[],thumbnail:mediaStrings.length>0?mediaStrings:[],date:moment().format('YYYY-MM-DD'),text:title};var temp_data={item_data:{block_type:'post',block_data:block_data},uuid:uuid,author:author,action:action};creatingPostMount({data:{text:title},temp_data:temp_data});}},[title,resetLocalStates,createPostMedia,medias,author,currentProfile]);var _onUploadProgress=useCallback(function(evt,id){var percentCompleted=Math.round(evt.loaded*100/evt.total);postMediaPercentCompletedMount({id:id,percentCompleted:percentCompleted});},[]);var handleAddFiles=useCallback(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(files){var filesArr,i,base64Url;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:filesArr=Array.from(files);i=0;case 2:if(!(i<filesArr.length)){_context.next=10;break;}_context.next=5;return fileToBase64(filesArr[i]);case 5:base64Url=_context.sent;if(typeof base64Url==='string'){(function(){var uuid=uuidV4();var formData=new FormData();formData.append('image',filesArr[i]);creatingPostMediaMount({data:formData,post_id:0,onUploadProgress:function onUploadProgress(e){return _onUploadProgress(e,uuid);},obj:{// id: uuid,\nstringUrl:base64Url,percentCompleted:0}});})();}case 7:i++;_context.next=2;break;case 10:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}(),[_onUploadProgress]);var handleDeleted=useCallback(function(item){if(item){var params={post_id:0,media_id:item.id};deleteUnCreatedPostMediaMount(params);}},[]);var handleSubmit=useCallback(function(){if(medias.length>0||title.trim().length>0){createPost();setCreatePost(false);}},[title,createPost,medias,setCreatePost]);useEffect(function(){if(clicked){setShowPostForm(false);}},[clicked]);return{file:file,title:title,images:images,setFile:setFile,postRef:postRef,setTitle:setTitle,handleSubmit:handleSubmit,showPostForm:showPostForm,handleDeleted:handleDeleted,handleAddFiles:handleAddFiles,setShowPostForm:setShowPostForm};}","map":{"version":3,"sources":["/Users/zuhriddinkamilzanov/Desktop/tMed-mobile/src/Hooks/post/use-creating-post.js"],"names":["useStore","v4","uuidV4","fileToBase64","$accountModel","moment","$tapeModel","creatingPostMediaMount","creatingPostMount","deleteUnCreatedPostMediaMount","postMediaPercentCompletedMount","resetPostMedia","post","useOutsideClicker","useCallback","useEffect","useRef","useState","useCreatingPost","setCreatePost","postRef","clicked","file","setFile","title","setTitle","images","setImages","currentProfile","$profiles","showPostForm","setShowPostForm","medias","$postMedia","data","author","slug_name","resetLocalStates","createPostMedia","createPostMediaId","createPost","uuid","mediaStrings","mediaIds","allow","length","i","push","gallery_id","id","image","stringUrl","thumbnail","action","params","post_id","block_data","type","name","avatar","is_official","isOfficial","date","format","text","temp_data","item_data","block_type","onUploadProgress","evt","percentCompleted","Math","round","loaded","total","handleAddFiles","files","filesArr","Array","from","base64Url","formData","FormData","append","e","obj","handleDeleted","item","media_id","handleSubmit","trim"],"mappings":"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","sourcesContent":["import {useStore} from 'effector-react'\r\nimport {v4 as uuidV4} from 'uuid'\r\nimport {fileToBase64} from '../../utils/crop-utils'\r\nimport {$accountModel} from '../../Models/account-model'\r\nimport moment from 'moment'\r\nimport {\r\n    $tapeModel,\r\n    creatingPostMediaMount,\r\n    creatingPostMount,\r\n    deleteUnCreatedPostMediaMount,\r\n    postMediaPercentCompletedMount,\r\n    resetPostMedia\r\n} from '../../Models/tape-model'\r\nimport post from '../../Service/post'\r\nimport {useOutsideClicker} from '../app/use-outside-clicker'\r\nimport {useCallback, useEffect, useRef, useState} from 'react'\r\n\r\n\r\nexport function useCreatingPost(setCreatePost) {\r\n    const postRef = useRef(null)\r\n    const {clicked} = useOutsideClicker(postRef)\r\n    const [file, setFile] = useState([])\r\n    const [title, setTitle] = useState('')\r\n    const [images, setImages] = useState([])\r\n    const {$profiles: {currentProfile}} = useStore($accountModel)\r\n    const [showPostForm, setShowPostForm] = useState(false)\r\n    const {$postMedia: {data: medias}} = useStore($tapeModel)\r\n    \r\n    const author = currentProfile && `@${currentProfile.slug_name}`\r\n    \r\n    const resetLocalStates = useCallback(() => {\r\n        setTitle('')\r\n        setFile([])\r\n        setImages([])\r\n        setShowPostForm(false)\r\n    }, [])\r\n    \r\n    const createPostMedia = useCallback((data) => {\r\n        post.createPostMediaId(data)\r\n    }, [])\r\n    \r\n    const createPost = useCallback(() => {\r\n        const uuid = uuidV4()\r\n        const mediaStrings = []\r\n        const mediaIds = []\r\n        let allow = true\r\n        \r\n        if (medias.length > 0) {\r\n            for (let i = 0; i < medias.length; i++) {\r\n                mediaIds.push({gallery_id: medias[i].id})\r\n                mediaStrings.push({\r\n                    id: medias[i].id,\r\n                    image: medias[i].stringUrl,\r\n                    thumbnail: medias[i].stringUrl\r\n                })\r\n                \r\n                if (typeof medias[i].id !== 'number') {\r\n                    allow = false\r\n                    break\r\n                }\r\n            }\r\n        }\r\n        \r\n        if (allow) {\r\n            const action = (id) => {\r\n                resetLocalStates()\r\n                if (mediaIds.length > 0) {\r\n                    const params = {\r\n                        post_id: id,\r\n                        data: mediaIds\r\n                    }\r\n                    createPostMedia(params)\r\n                    resetPostMedia()\r\n                }\r\n            }\r\n            \r\n            const block_data = {\r\n                action: null,\r\n                id: uuid,\r\n                author: {\r\n                    type: 'user',\r\n                    name: currentProfile.name,\r\n                    avatar: currentProfile.avatar,\r\n                    slug_name: currentProfile.slug_name,\r\n                    is_official: currentProfile.isOfficial\r\n                },\r\n                medias: mediaStrings.length > 0 ? mediaStrings : [],\r\n                thumbnail: mediaStrings.length > 0 ? mediaStrings : [],\r\n                date: moment().format('YYYY-MM-DD'),\r\n                text: title\r\n            }\r\n            const temp_data = {\r\n                item_data: {\r\n                    block_type: 'post',\r\n                    block_data: block_data\r\n                },\r\n                uuid,\r\n                author,\r\n                action\r\n            }\r\n            creatingPostMount({data: {text: title}, temp_data})\r\n        }\r\n    }, [title, resetLocalStates, createPostMedia, medias, author, currentProfile])\r\n    \r\n    const onUploadProgress = useCallback((evt, id) => {\r\n        let percentCompleted = Math.round((evt.loaded * 100) / evt.total)\r\n        postMediaPercentCompletedMount({id, percentCompleted})\r\n    }, [])\r\n    \r\n    const handleAddFiles = useCallback(async (files) => {\r\n        const filesArr = Array.from(files)\r\n        for (let i = 0; i < filesArr.length; i++) {\r\n            const base64Url = await fileToBase64(filesArr[i])\r\n            if (typeof base64Url === 'string') {\r\n                const uuid = uuidV4()\r\n                \r\n                const formData = new FormData()\r\n                formData.append('image', filesArr[i])\r\n                creatingPostMediaMount({\r\n                    data: formData,\r\n                    post_id: 0,\r\n                    onUploadProgress: (e) => onUploadProgress(e, uuid),\r\n                    obj: {\r\n                        // id: uuid,\r\n                        stringUrl: base64Url,\r\n                        percentCompleted: 0\r\n                    }\r\n                })\r\n            }\r\n        }\r\n    }, [onUploadProgress])\r\n    \r\n    const handleDeleted = useCallback((item) => {\r\n        if (item) {\r\n            const params = {\r\n                post_id: 0,\r\n                media_id: item.id\r\n            }\r\n            deleteUnCreatedPostMediaMount(params)\r\n        }\r\n    }, [])\r\n    \r\n    const handleSubmit = useCallback(() => {\r\n        if (medias.length > 0 || title.trim().length > 0) {\r\n            createPost()\r\n            setCreatePost(false)\r\n        }\r\n    }, [title, createPost, medias, setCreatePost])\r\n    \r\n    useEffect(() => {\r\n        if (clicked) {\r\n            setShowPostForm(false)\r\n        }\r\n    }, [clicked])\r\n    \r\n    \r\n    return {\r\n        file,\r\n        title,\r\n        images,\r\n        setFile,\r\n        postRef,\r\n        setTitle,\r\n        handleSubmit,\r\n        showPostForm,\r\n        handleDeleted,\r\n        handleAddFiles,\r\n        setShowPostForm\r\n    }\r\n}"]},"metadata":{},"sourceType":"module"}