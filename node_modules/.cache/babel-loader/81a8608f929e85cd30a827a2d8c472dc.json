{"ast":null,"code":"import _defineProperty from\"/Users/zuhriddinkamilzanov/Desktop/t-med(mobile)/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _slicedToArray from\"/Users/zuhriddinkamilzanov/Desktop/t-med(mobile)/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{useCallback,useEffect,useState}from'react';import{useStore}from'effector-react';import{$appModel}from'../../Models/app';import useWebSocket from'react-use-websocket';import{onlineUserMount}from'../../Models/user-model';export function useCommonWs(){var _useStore=useStore($appModel),token=_useStore.$app.token;var _useState=useState(null),_useState2=_slicedToArray(_useState,2),generalWSUrl=_useState2[0],setGeneralWSUrl=_useState2[1];var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),time=_useState4[0],setTime=_useState4[1];// const [closed, setClosed] = useState({})\nvar _useState5=useState(null),_useState6=_slicedToArray(_useState5,2),tabVisibility=_useState6[0],setTabVisibility=_useState6[1];var _useWebSocket=useWebSocket(generalWSUrl,{onMessage:function onMessage(e){var data=JSON.parse(e.data);// console.log(data)\n// console.log(data)\nif(data.type==='online_status'){var msg=_defineProperty({},data.object.username,{time:new Date().getTime()});onlineUserMount(msg);}},onOpen:function onOpen(e){// console.log(e)\n// setClosed({})\n},onClose:function onClose(e){// console.log(e)\n// setClosed({general: true})\n},onError:function onError(e){console.log('error from use-common-ws in app hook');}}),sendMessage=_useWebSocket.sendMessage;useEffect(function(){if(token){setGeneralWSUrl(\"wss://py.dwed.biz/ws/v1.0/user/general/?token=\".concat(token));}else{setGeneralWSUrl(null);}},[token]);var getTabVisibility=useCallback(function(){if(document.visibilityState==='visible'){setTabVisibility(document.visibilityState);}if(document.visibilityState==='hidden'){setTabVisibility(null);setTime(null);}},[]);useEffect(function(){getTabVisibility();window.addEventListener('visibilitychange',getTabVisibility);return function(){return window.removeEventListener('visibilityChange',getTabVisibility);};},[getTabVisibility]);useEffect(function(){var timeout=null;if(token){var data={im_online:'1'};if(!time){setTime(new Date().getTime());sendMessage(JSON.stringify(data));}else{if(tabVisibility&&tabVisibility==='visible'){timeout=setInterval(function(){var now=new Date();if(time&&now.getTime()-time>10000){setTime(now.getTime());// console.log(now)\nsendMessage(JSON.stringify(data));}},10000);}}}return function(){clearInterval(timeout);timeout=null;};},[token,time,sendMessage,tabVisibility]);}","map":null,"metadata":{},"sourceType":"module"}